# riscv64-unknown-elf-gdbå’ŒQEMU

æ¥ä¸‹æ¥æˆ‘ä»¬å°†ç»“åˆä½¿ç”¨ `riscv64-unknown-elf-gdb` å’Œ QEMU æ¥è°ƒè¯• RISC-V çš„ç¨‹åºã€‚QEMU æ˜¯ä¸€ä¸ªå¼€æºçš„æ¨¡æ‹Ÿå™¨ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿä¸åŒæ¶æ„çš„ç¡¬ä»¶ç¯å¢ƒï¼Œè€Œ `riscv64-unknown-elf-gdb` åˆ™æ˜¯ä¸“é—¨ä¸º RISC-V ç›®æ ‡ç¼–è¯‘çš„ GDB è°ƒè¯•å™¨ã€‚å›é¡¾[`riscv64-unknown-elf-gdb` å’Œ `gdb`çš„åŒºåˆ«](https://lzzs.fun/rCore-notebook/0-GDB-use.html#riscv64-unknown-elf-gdb-å’Œ-gdbçš„åŒºåˆ«)ã€‚

## ä¸€ã€å°è¯• `Hello, world!\n`âœ–ï¸10

å°†ä¸ŠèŠ‚çš„`hello.c`å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬æ¥å°è¯•ä½¿ç”¨ `riscv64-unknown-elf-gdb` å’Œ QEMU åœ¨ RISC-V æ¶æ„ä¸‹è°ƒè¯•å®ƒã€‚

### 1. ç¼–è¯‘ RISC-V ç¨‹åº

é¦–å…ˆå°†`hello.c`ç¨‹åºä¸º RISC-V æ¶æ„ç¼–è¯‘ã€‚å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ `gcc` å‘½ä»¤æ¥ç¼–è¯‘ä½ çš„ç¨‹åºï¼š

```bash
riscv64-unknown-elf-gcc -g -o hello hello.c
```

- `-g` é€‰é¡¹ä¼šç¡®ä¿ç¼–è¯‘åçš„ç¨‹åºåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼Œæ–¹ä¾¿ GDB ä½¿ç”¨ã€‚
- `hello.c` æ˜¯ä½ çš„æºä»£ç æ–‡ä»¶ï¼Œ`hello` æ˜¯ç¼–è¯‘ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ï¼ˆRISC-V æ¶æ„çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€‚

### 2. ä½¿ç”¨ QEMU è¿è¡Œ RISC-V ç¨‹åº

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ QEMU æ¥æ¨¡æ‹Ÿ RISC-V ç¯å¢ƒå¹¶è¿è¡Œåˆšåˆšç¼–è¯‘çš„ `hello` ç¨‹åºã€‚å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
qemu-system-riscv64 -machine virt -nographic -kernel hello.elf -s -S
```

- **`-machine virt`**ï¼šé€‰æ‹© QEMU ä¸­çš„è™šæ‹Ÿ RISC-V æœºå™¨ã€‚
- **`-nographic`**ï¼šè¡¨ç¤ºä¸ä½¿ç”¨å›¾å½¢ç•Œé¢ï¼Œæ‰€æœ‰è¾“å‡ºé€šè¿‡å½“å‰ç»ˆç«¯å¤„ç†ã€‚
- **`-kernel hello`**ï¼šæŒ‡å®šè¦åŠ è½½å¹¶è¿è¡Œçš„ RISC-V ç¨‹åºã€‚
- **`-s`**ï¼šå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œä¼šåœ¨ç«¯å£ 1234 ä¸Šå¼€å¯ä¸€ä¸ª GDB æœåŠ¡å™¨ã€‚
- **`-S`**ï¼šå‘Šè¯‰ QEMU åœ¨å¯åŠ¨åæš‚åœ CPUï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥è¿æ¥ GDB è¿›è¡Œè°ƒè¯•ï¼Œè€Œä¸ä¼šç«‹å³è¿è¡Œç¨‹åºã€‚

æ­¤æ—¶ï¼ŒQEMU ä¼šå¯åŠ¨ï¼Œä½†å®ƒä¼šå¤„äºæš‚åœçŠ¶æ€ï¼Œç­‰å¾… GDB è¿æ¥ã€‚

### 3. ä½¿ç”¨ `riscv64-unknown-elf-gdb` è¿æ¥ QEMU

ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ GDB è¿æ¥åˆ° QEMU å¹¶è°ƒè¯•ç¨‹åºã€‚é¦–å…ˆå¯åŠ¨ `riscv64-unknown-elf-gdb`ï¼š

```bash
riscv64-unknown-elf-gdb hello.elf
```

- `hello.elf` æ˜¯ä¹‹å‰ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒGDB ä¼šåŠ è½½å®ƒçš„è°ƒè¯•ä¿¡æ¯ã€‚

ç„¶ååœ¨ GDB ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œè¿æ¥åˆ° QEMU çš„è°ƒè¯•æœåŠ¡å™¨ï¼š

```bash
(gdb) target remote localhost:1234
```

- è¿™é‡Œçš„ `localhost:1234` æ˜¯ QEMU é»˜è®¤å¼€å¯çš„è°ƒè¯•ç«¯å£ã€‚

### 4. è®¾ç½®æ–­ç‚¹å’Œè°ƒè¯•

ç°åœ¨ï¼Œä½ å·²ç»æˆåŠŸè¿æ¥åˆ°äº† QEMU æ¨¡æ‹Ÿçš„ RISC-V ç¯å¢ƒï¼Œå¯ä»¥å¼€å§‹è°ƒè¯•äº†ã€‚

> ### æŠ¥é”™1ï¼šç­‰ä¸€ä¸‹ï¼Ÿæˆ‘çš„ç¬¬ä¸€æ­¥ç¼–è¯‘å°±å‡ºé”™äº†
>
> ![QQ_1727413274166](../assets/QQ_1727413274166.png)

## äºŒã€RISC-V è£¸æœºç¼–ç¨‹

åœ¨RISC-Vè£¸æœºç¼–ç¨‹ï¼ˆbare-metal programmingï¼‰ä¸­ï¼Œå°†æ— æ³•å†ä½¿ç”¨ `stdio.h` è¿™æ ·çš„æ ‡å‡†Cåº“å¤´æ–‡ä»¶ï¼Œä¸»è¦åŸå› æ˜¯è£¸æœºç¼–ç¨‹ä¸æ“ä½œç³»ç»Ÿç¯å¢ƒçš„å·®å¼‚ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„è§£é‡Šï¼š

### 1. **è£¸æœºç¼–ç¨‹ä¸æ“ä½œç³»ç»Ÿçš„åŒºåˆ«**

åœ¨æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Linuxã€Windows ç­‰ï¼‰ä¸Šï¼ŒC æ ‡å‡†åº“ï¼ˆåŒ…æ‹¬ `stdio.h`ï¼‰ä¾èµ–æ“ä½œç³»ç»Ÿæä¾›çš„åŠŸèƒ½å’ŒæœåŠ¡æ¥æ‰§è¡Œè¾“å…¥è¾“å‡ºç­‰æ“ä½œã€‚ä¾‹å¦‚ï¼Œ`printf` å‡½æ•°ä¾èµ–äºæ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem callï¼‰ï¼Œå°†æ•°æ®å‘é€åˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼ˆå¦‚å±å¹•æˆ–ç»ˆç«¯ï¼‰ã€‚æ“ä½œç³»ç»Ÿä¼šç®¡ç†è¿™äº›èµ„æºå’Œè®¾å¤‡ï¼Œæä¾›æ–‡ä»¶ç³»ç»Ÿã€å†…å­˜ç®¡ç†ã€ç¡¬ä»¶æŠ½è±¡ç­‰åŠŸèƒ½ã€‚

è€Œè£¸æœºç¼–ç¨‹ä¸­ï¼Œç¨‹åºç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šï¼Œæ²¡æœ‰æ“ä½œç³»ç»Ÿçš„å¸®åŠ©ï¼Œä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ã€‚å› æ­¤ï¼Œè¯¸å¦‚ `stdio.h` å¤´æ–‡ä»¶ä¸­å®šä¹‰çš„æ ‡å‡†è¾“å…¥è¾“å‡ºå‡½æ•°ï¼ˆå¦‚ `printf`ã€`scanf`ï¼‰éƒ½æ— æ³•å·¥ä½œï¼Œå› ä¸ºå®ƒä»¬ä¾èµ–äºæ“ä½œç³»ç»Ÿæ¥ç®¡ç†ç¡¬ä»¶èµ„æºã€‚

### 2. **`stdio.h` çš„åŠŸèƒ½ä¾èµ–**

`stdio.h` æä¾›çš„åŠŸèƒ½ä¸»è¦ç”¨äºæ ‡å‡†è¾“å…¥è¾“å‡ºæµçš„æ“ä½œï¼ŒåŒ…æ‹¬æ–‡ä»¶çš„è¯»å–å†™å…¥å’Œæ ¼å¼åŒ–è¾“å‡ºã€‚è¿™äº›åŠŸèƒ½åœ¨æ“ä½œç³»ç»Ÿç¯å¢ƒä¸‹æ˜¯é€šè¿‡ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ï¼ˆä¾‹å¦‚ POSIX æ ‡å‡†ä¸­çš„ `write()`ã€`read()`ï¼‰å®ç°çš„ã€‚è€Œåœ¨è£¸æœºç¯å¢ƒä¸­ï¼š

- **æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿ**ï¼šè£¸æœºç¨‹åºæ²¡æœ‰æ“ä½œç³»ç»Ÿæä¾›çš„æ–‡ä»¶ç³»ç»Ÿæ¥ç®¡ç†æ–‡ä»¶ï¼Œå› æ­¤æ ‡å‡†è¾“å…¥è¾“å‡ºæµæ— æ³•æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶æˆ–è®¾å¤‡ã€‚
- **æ²¡æœ‰è®¾å¤‡é©±åŠ¨ç¨‹åº**ï¼šæ“ä½œç³»ç»Ÿè´Ÿè´£ç®¡ç†è®¾å¤‡ï¼ˆå¦‚æ˜¾ç¤ºå™¨ã€é”®ç›˜ã€ç½‘ç»œæ¥å£ç­‰ï¼‰å¹¶æä¾›é©±åŠ¨ç¨‹åºã€‚è£¸æœºç¨‹åºåˆ™å¿…é¡»ç›´æ¥æ“ä½œç¡¬ä»¶å¯„å­˜å™¨ä¸å¤–è®¾é€šä¿¡ï¼Œè€Œæ ‡å‡†åº“æ— æ³•æä¾›è¿™æ ·çš„åŠŸèƒ½ã€‚
  
ä¾‹å¦‚ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨ `printf` è¾“å‡ºä¿¡æ¯æ—¶ï¼Œå®é™…æ‰§è¡Œçš„æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡ºè®¾å¤‡ã€‚è€Œåœ¨è£¸æœºç¨‹åºä¸­ï¼Œæ²¡æœ‰ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤ `printf` æ— æ³•æ­£å¸¸å·¥ä½œã€‚

### 3. **æ›¿ä»£æ–¹æ¡ˆï¼šSBI è°ƒç”¨æˆ–ç›´æ¥è®¿é—®ç¡¬ä»¶**

åœ¨è£¸æœºç¯å¢ƒä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥å®ç°ä¸å¤–ç•Œçš„äº¤äº’ï¼š

#### 1) **SBIï¼ˆSupervisor Binary Interfaceï¼‰è°ƒç”¨**

   åœ¨ RISC-V è£¸æœºç¼–ç¨‹ä¸­ï¼Œé€šå¸¸ä¾èµ– `SBI`ï¼ˆSupervisor Binary Interfaceï¼‰æä¾›çš„æ¥å£æ¥æ‰§è¡ŒæŸäº›åŸºæœ¬çš„ç¡¬ä»¶æ“ä½œã€‚`SBI` æ˜¯ RISC-V ä¸­ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æƒæ¨¡å¼ä¸‹çš„å°å‹è¿è¡Œç¯å¢ƒï¼Œæä¾›äº†è£¸æœºç¨‹åºå’Œç¡¬ä»¶ä¹‹é—´çš„æŠ½è±¡æ¥å£ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `ecall` æŒ‡ä»¤ä¸ SBI é€šä¿¡ï¼Œå¯ä»¥æ‰§è¡Œæ§åˆ¶å°è¾“å‡ºã€å…³æœºã€æ—¶é—´ä¸­æ–­ç­‰æ“ä½œã€‚

ç±»ä¼¼ä¸‹é¢çš„ `sbi_call()` å‡½æ•°ï¼Œé€šè¿‡ `SBI_CONSOLE_PUTCHAR` å®ç°å­—ç¬¦è¾“å‡ºï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `stdio.h` çš„ `printf`ã€‚

   ```c
   #define SBI_CONSOLE_PUTCHAR 0x1
   
   static inline void sbi_call(uint64_t sbi_num, uint64_t arg0) {
       register uint64_t a0 asm ("a0") = arg0;
       register uint64_t a7 asm ("a7") = sbi_num;
       asm volatile ("ecall" : "+r"(a0) : "r"(a7) : "memory");
   }
   
   void print_char(char c) {
       sbi_call(SBI_CONSOLE_PUTCHAR, c);
   }
   ```

#### 2) **ç›´æ¥è®¿é—®ç¡¬ä»¶**

   åœ¨è£¸æœºç¯å¢ƒä¸­ï¼Œå¸¸å¸¸éœ€è¦ç›´æ¥æ“ä½œç¡¬ä»¶è®¾å¤‡ï¼Œæ¯”å¦‚ç›´æ¥å†™å…¥ç¡¬ä»¶å¯„å­˜å™¨æ¥æ§åˆ¶ä¸²å£è¾“å‡ºã€‚ä»¥ UARTï¼ˆé€šç”¨å¼‚æ­¥æ”¶å‘ä¼ è¾“å™¨ï¼‰ä¸ºä¾‹ï¼Œè£¸æœºç¨‹åºå¯ä»¥é€šè¿‡ç›´æ¥è®¿é—®ä¸²å£çš„å¯„å­˜å™¨ï¼Œå®ç°å­—ç¬¦çš„è¾“å‡ºå’Œè¾“å…¥ï¼Œè€Œä¸éœ€è¦ä¾èµ– `stdio.h`ã€‚

### 4. **RISC-V è£¸æœºç¼–ç¨‹ä¸­çš„å¸¸è§è¾“å…¥è¾“å‡ºæ–¹å¼**

1. **UART ä¸²å£è¾“å‡º**ï¼šè£¸æœºç¨‹åºå¯ä»¥é€šè¿‡è®¿é—® UART å¯„å­˜å™¨ï¼Œå‘é€æ•°æ®åˆ°ç»ˆç«¯è®¾å¤‡ã€‚å¯¹äºå¾ˆå¤šè£¸æœºç¨‹åºæ¥è¯´ï¼ŒUART æ˜¯æœ€å¸¸è§çš„è°ƒè¯•è¾“å‡ºæ‰‹æ®µã€‚

2. **SBI è°ƒç”¨**ï¼šRISC-V æä¾›äº† SBI è§„èŒƒï¼Œåœ¨è£¸æœºç¨‹åºä¸­ï¼Œå¯ä»¥é€šè¿‡ `ecall` æŒ‡ä»¤ä¸ SBI äº¤äº’ï¼Œå®Œæˆè¾“å‡ºå­—ç¬¦åˆ°æ§åˆ¶å°çš„åŠŸèƒ½ï¼Œå¦‚ä¸Šé¢çš„ä»£ç ä¸­é€šè¿‡ `SBI_CONSOLE_PUTCHAR` å®ç°å­—ç¬¦è¾“å‡ºã€‚

### 5. åœ¨è£¸æœºç¯å¢ƒä¸­ä½¿ç”¨ Rust å’Œ `core` åº“

åœ¨ **Rust è£¸æœºç¼–ç¨‹** ä¸­ï¼Œç”±äºæ²¡æœ‰æ“ä½œç³»ç»Ÿçš„æ”¯æŒï¼Œæ ‡å‡†åº“ (`std`) åŒæ ·æ˜¯ä¸èƒ½ä½¿ç”¨çš„ã€‚å› ä¸ºæ ‡å‡†åº“ä¾èµ–æ“ä½œç³»ç»Ÿæä¾›çš„åŠŸèƒ½ï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œç­‰ï¼‰ã€‚ä½†æ˜¯ï¼Œ**`core` åº“** æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œå› ä¸ºå®ƒæ˜¯ `no_std` ç¯å¢ƒä¸­çš„åŸºç¡€åº“ï¼Œä¸ä¾èµ–æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚

`core` åº“æä¾›äº†è®¸å¤šåŸºç¡€åŠŸèƒ½ï¼Œæ¯”å¦‚åŸºç¡€çš„æ•°æ®ç±»å‹ã€æ•°å­¦è¿ç®—ã€å†…å­˜æ“ä½œç­‰ï¼Œä½†ä¸åŒ…æ‹¬ I/Oã€çº¿ç¨‹ã€æ–‡ä»¶æ“ä½œç­‰ã€‚è¿™æ ·å°±å…è®¸åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„è£¸æœºç¯å¢ƒä¸‹ç¼–å†™ Rust ä»£ç ã€‚æ›´å¤šå†…å®¹è§ä¸‹ä¸€èŠ‚ã€‚

## ä¸‰ã€ä¸ä½¿ç”¨æ ‡å‡†åº“çš„ Hello World C ä»£ç 

ç°åœ¨æˆ‘ä»¬éœ€è¦å°† `Hello, world!\n`âœ–ï¸10 æ›¿æ¢ä¸ºä¸€ä¸ªä¸ä½¿ç”¨æ ‡å‡†åº“çš„ Hello World C ä»£ç ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¸å¸¦æ ‡å‡†åº“çš„ "Hello, World" C ç¨‹åºï¼Œé€‚ç”¨äº `riscv64-unknown-elf-gdb` å’Œ QEMU æ¨¡æ‹Ÿçš„ RISC-V ç¯å¢ƒã€‚æˆ‘ä»¬å°†ä½¿ç”¨ RISC-V çš„ SBIï¼ˆSupervisor Binary Interfaceï¼‰æ¥è¿›è¡Œå­—ç¬¦è¾“å‡ºã€‚

### ä¸ä½¿ç”¨æ ‡å‡†åº“çš„ Hello World C ä»£ç ï¼ˆé€‚ç”¨äº RISC-V è£¸æœºç¼–ç¨‹ï¼‰

```c
// hello.c

// å®šä¹‰æ ‡å‡†æ•´æ•°ç±»å‹ï¼ˆæ‰‹åŠ¨å®šä¹‰ï¼‰
typedef unsigned long long uint64_t;
typedef unsigned int uint32_t;
typedef unsigned char uint8_t;

#define SBI_CONSOLE_PUTCHAR 0x1

static inline void sbi_call(uint64_t sbi_num, uint64_t arg0, uint64_t arg1, uint64_t arg2) {
    register uint64_t a0 asm ("a0") = arg0;
    register uint64_t a1 asm ("a1") = arg1;
    register uint64_t a2 asm ("a2") = arg2;
    register uint64_t a7 asm ("a7") = sbi_num;
    asm volatile ("ecall"
                  : "+r"(a0)
                  : "r"(a1), "r"(a2), "r"(a7)
                  : "memory");
}

void print_char(char c) {
    sbi_call(SBI_CONSOLE_PUTCHAR, c, 0, 0);
}

void print_string(const char* str) {
    while (*str) {
        print_char(*str++);
    }
}

int main() {
    print_string("Hello, World! x10 (fake)\n");
    while (1) {} // æ— é™å¾ªç¯ï¼Œé˜²æ­¢ç¨‹åºé€€å‡º
    return 0;
}
```

### ä»£ç è¯´æ˜

1. **æ‰‹åŠ¨å®šä¹‰å›ºå®šå®½åº¦æ•´æ•°ç±»å‹**ï¼šç”±äº `stdint.h` æ— æ³•ä½¿ç”¨ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å®šä¹‰äº†å¸¸è§çš„å›ºå®šå®½åº¦æ•´æ•°ç±»å‹ï¼Œæ¯”å¦‚ `uint64_t`ã€`uint32_t` å’Œ `uint8_t`ã€‚
   - `typedef unsigned long long uint64_t;`ï¼šå®šä¹‰ 64 ä½æ— ç¬¦å·æ•´æ•°ã€‚
   - `typedef unsigned int uint32_t;`ï¼šå®šä¹‰ 32 ä½æ— ç¬¦å·æ•´æ•°ã€‚
   - `typedef unsigned char uint8_t;`ï¼šå®šä¹‰ 8 ä½æ— ç¬¦å·æ•´æ•°ã€‚
2. **SBI è°ƒç”¨**ï¼šæˆ‘ä»¬ä½¿ç”¨ RISC-V çš„ SBIï¼ˆSupervisor Binary Interfaceï¼‰æ¥å‘æ§åˆ¶å°è¾“å‡ºå­—ç¬¦ã€‚SBI æ˜¯ä¸€ç§æ“ä½œç³»ç»Ÿä¸åº•å±‚ç¡¬ä»¶é€šä¿¡çš„æ¥å£ï¼Œç±»ä¼¼äº x86 æ¶æ„çš„ BIOS ä¸­æ–­ã€‚
   - `SBI_CONSOLE_PUTCHAR`ï¼šSBI æä¾›äº†æ§åˆ¶å°è¾“å‡ºå­—ç¬¦çš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£ç¼–å·æ˜¯ 0x1ã€‚
3. **`sbi_call` å‡½æ•°**ï¼šä½¿ç”¨å†…è”æ±‡ç¼–æŒ‡ä»¤ `ecall` å®ç°çš„ SBI è°ƒç”¨ï¼Œç”¨äºä¸ç¡¬ä»¶äº¤äº’ã€‚
4. **`print_char` å‡½æ•°**ï¼šè°ƒç”¨ `sbi_call` å‘æ§åˆ¶å°è¾“å‡ºå•ä¸ªå­—ç¬¦ã€‚
5. **`print_string` å‡½æ•°**ï¼šå¾ªç¯è°ƒç”¨ `print_char` æ¥è¾“å‡ºå­—ç¬¦ä¸²ã€‚
6. **`main` å‡½æ•°**ï¼šç¨‹åºçš„å…¥å£ï¼Œè°ƒç”¨ `print_string` è¾“å‡º "Hello, World! x10 (fake)"ï¼Œä¹‹åè¿›å…¥æ— é™å¾ªç¯ï¼Œé˜²æ­¢ç¨‹åºé€€å‡ºã€‚

> ### è¯¦ç»†ä»£ç è¯´æ˜
>
> ### 1. **å®šä¹‰æ ‡å‡†æ•´æ•°ç±»å‹**
>
> ```c
> typedef unsigned long long uint64_t;
> typedef unsigned int uint32_t;
> typedef unsigned char uint8_t;
> ```
>
> è¿™ä¸‰è¡Œä»£ç å®šä¹‰äº†æ ‡å‡†çš„æ— ç¬¦å·æ•´æ•°ç±»å‹ï¼š
>
> - `uint64_t` æ˜¯æ— ç¬¦å· 64 ä½æ•´æ•°ï¼ˆ`unsigned long long`ï¼‰ã€‚
> - `uint32_t` æ˜¯æ— ç¬¦å· 32 ä½æ•´æ•°ï¼ˆ`unsigned int`ï¼‰ã€‚
> - `uint8_t` æ˜¯æ— ç¬¦å· 8 ä½æ•´æ•°ï¼ˆ`unsigned char`ï¼‰ã€‚
>
> è¿™äº›ç±»å‹é€šå¸¸åœ¨è£¸æœºç¼–ç¨‹ä¸­ç”¨äºç¡®ä¿æ˜ç¡®çš„ä½å®½ï¼Œå› ä¸ºä¸åŒå¹³å°ä¸Š `int` å’Œ `long` çš„ä½å®½å¯èƒ½æœ‰æ‰€ä¸åŒã€‚
>
> ä»£ç å†…å®¹åªä½¿ç”¨äº†`uint64_t`ï¼Œä¸ºäº†å¢åŠ ä»£ç çš„å¥å£®æ€§å’Œå¯ç§»æ¤æ€§ï¼Œæ‰‹åŠ¨å®šä¹‰äº†é¢å¤–çš„æ•´æ•°ç±»å‹ï¼ˆ32 ä½å’Œ 8 ä½ï¼‰ï¼Œå³ä¾¿å®ƒä»¬åœ¨è¿™æ®µä»£ç ä¸­æ²¡æœ‰ç›´æ¥ç”¨åˆ°ã€‚
>
> ### 2. **SBI Console Putchar å®šä¹‰**
>
> ```c
> #define SBI_CONSOLE_PUTCHAR 0x1
> ```
>
> è¿™æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œç”¨äºæŒ‡å®š `SBI` è°ƒç”¨çš„ç¼–å·ã€‚`SBI_CONSOLE_PUTCHAR` çš„å€¼ä¸º `0x1`ï¼Œå®ƒæ˜¯ RISC-V `SBI` è°ƒç”¨æ¥å£ä¸­çš„ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œç”¨äºå‘æ§åˆ¶å°è¾“å‡ºä¸€ä¸ªå­—ç¬¦ã€‚
>
> `SBI`ï¼ˆSupervisor Binary Interfaceï¼‰æ˜¯ RISC-V çš„ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œå…è®¸è£¸æœºç¨‹åºï¼ˆè¿è¡Œåœ¨æœºå™¨æ¨¡å¼æˆ–è¶…çº§æ¨¡å¼çš„ç¨‹åºï¼‰é€šè¿‡ `ecall` æŒ‡ä»¤ä¸åº•å±‚å›ºä»¶ï¼ˆå¦‚ OpenSBIï¼‰äº¤äº’ã€‚`SBI_CONSOLE_PUTCHAR` æ˜¯ `SBI` çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨äºå­—ç¬¦è¾“å‡ºã€‚
>
> ### 3. **SBI è°ƒç”¨å®ç°**
>
> ```c
> static inline void sbi_call(uint64_t sbi_num, uint64_t arg0, uint64_t arg1, uint64_t arg2) {
>     register uint64_t a0 asm ("a0") = arg0;
>     register uint64_t a1 asm ("a1") = arg1;
>     register uint64_t a2 asm ("a2") = arg2;
>     register uint64_t a7 asm ("a7") = sbi_num;
>     asm volatile ("ecall"
>                   : "+r"(a0)
>                   : "r"(a1), "r"(a2), "r"(a7)
>                   : "memory");
> }
> ```
>
> è§£é‡Šï¼š
>
> 1. **å‡½æ•°å®šä¹‰**ï¼š`sbi_call` æ˜¯ä¸€ä¸ªå†…è”å‡½æ•°ï¼ˆ`inline` å‡½æ•°ï¼‰ï¼Œè¡¨ç¤ºç¼–è¯‘å™¨åœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶ä¸ä¼šäº§ç”Ÿå®é™…çš„å‡½æ•°è°ƒç”¨ï¼Œè€Œæ˜¯å°†å‡½æ•°ä½“åµŒå…¥åˆ°è°ƒç”¨è¯¥å‡½æ•°çš„ä½ç½®ï¼Œä»è€Œé¿å…å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚è¯¥å‡½æ•°é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ `ecall` æ¥æ‰§è¡Œ `SBI` è°ƒç”¨ã€‚
>
> 2. **å¯„å­˜å™¨ç»‘å®š**ï¼š
>    - `register uint64_t a0 asm ("a0") = arg0;` é€šè¿‡ `asm ("a0")` å°† C è¯­è¨€ä¸­çš„å˜é‡ `arg0` ç»‘å®šåˆ° RISC-V çš„ `a0` å¯„å­˜å™¨ã€‚
>    - åŒç†ï¼Œ`a1`ã€`a2` åˆ†åˆ«ç»‘å®šåˆ° RISC-V çš„ `a1` å’Œ `a2` å¯„å­˜å™¨ï¼Œ`a7` å¯„å­˜å™¨ç»‘å®šåˆ° `sbi_num`ï¼Œå³ `SBI` è°ƒç”¨ç¼–å·ã€‚
>
> 3. **æ±‡ç¼–æŒ‡ä»¤ `ecall`**ï¼š
>    - `ecall` æ˜¯ RISC-V ä¸­çš„ä¸€ä¸ªç‰¹æƒæŒ‡ä»¤ï¼Œç”¨äºåœ¨æœºå™¨æ¨¡å¼ï¼ˆM-modeï¼‰æˆ–è¶…çº§æ¨¡å¼ï¼ˆS-modeï¼‰ä¸‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼ˆç±»ä¼¼äº x86 æ¶æ„ä¸­çš„ `syscall` æŒ‡ä»¤ï¼‰ã€‚æ­¤æŒ‡ä»¤è§¦å‘é™·å…¥ç³»ç»Ÿçš„ç‰¹æƒæ¨¡å¼ï¼Œé€šè¿‡ `SBI` ä¸åº•å±‚å›ºä»¶äº¤äº’ã€‚
>    - `asm volatile` å£°æ˜å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦ä¼˜åŒ–æ‰è¿™ä¸ªæ±‡ç¼–å—ï¼Œå¹¶ä¸”è¦ç¡®ä¿å…¶å‰¯ä½œç”¨ä¼šè¢«æ‰§è¡Œã€‚
>
> 4. **è¾“å…¥è¾“å‡ºçº¦æŸ**ï¼š
>    - `"+r"(a0)` è¡¨ç¤º `a0` å¯„å­˜å™¨ä¼šåœ¨è°ƒç”¨å‰åéƒ½è¢«ä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­å¯èƒ½è¢«ä¿®æ”¹ï¼ˆ"read-write"ï¼‰ã€‚
>    - `"r"(a1), "r"(a2), "r"(a7)` è¡¨ç¤º `a1`ã€`a2` å’Œ `a7` ä½œä¸ºè¾“å…¥å¯„å­˜å™¨ï¼ŒæŒ‡ä»¤åªä¼šè¯»å–è¿™äº›å¯„å­˜å™¨çš„å€¼ã€‚
>    - `"memory"` è¡¨ç¤ºè¯¥æ±‡ç¼–æŒ‡ä»¤ä¼šå¯¹å†…å­˜æœ‰å½±å“ï¼Œé˜²æ­¢ç¼–è¯‘å™¨å¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æ’ã€‚
>
> > åœ¨ RISC-V çš„ `SBI` è°ƒç”¨ä¸­ï¼Œæœ‰æ—¶å¯èƒ½éœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°ã€‚åœ¨è¿™é‡Œå¯ä»¥åªä¼ é€’ä¸€ä¸ªå­—ç¬¦æ•°æ®ï¼Œå³ `arg1` å’Œ `arg2` æ˜¯ä¸å¿…è¦çš„ï¼Œç›´æ¥ä½¿ç”¨ä¸¤ä¸ªå‚æ•°å³å¯ã€‚
> >
> > æä¾›é¢å¤–çš„ `arg1` å’Œ `arg2` å‚æ•°ï¼Œæ˜¯ä¸ºäº†æ›´é€šç”¨çš„ç”¨é€”ã€‚å°½ç®¡åœ¨ `print_char` ä¸­ä¸éœ€è¦è¿™äº›å‚æ•°ï¼Œä½†è¿™ä½¿å¾— `sbi_call` æ›´åŠ é€šç”¨ï¼Œå¯ä»¥åœ¨å…¶ä»–åœºæ™¯ä¸­ä½¿ç”¨æ›´å¤šçš„å¯„å­˜å™¨ä¼ é€’é¢å¤–ä¿¡æ¯ã€‚
> >
> > **ä½¿ç”¨ä¸¤ä¸ªå‚æ•°çš„ç‰ˆæœ¬**
> >
> > ```c
> > static inline void sbi_call(uint64_t sbi_num, uint64_t arg0) {
> >     register uint64_t a0 asm ("a0") = arg0;
> >     register uint64_t a7 asm ("a7") = sbi_num;
> >     asm volatile ("ecall"
> >                   : "+r"(a0)
> >                   : "r"(a7)
> >                   : "memory");
> > }
> > ```
> >
> >
>
> æ€»ç»“ï¼š
>
> è¯¥å‡½æ•°é€šè¿‡ `ecall` å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä½¿ç”¨ `a0` åˆ° `a7` å¯„å­˜å™¨ä¼ é€’å‚æ•°ã€‚`a0` æ˜¯è¿”å›å€¼å¯„å­˜å™¨ï¼Œè€Œ `a7` ç”¨äºä¼ é€’ `SBI` ç¼–å·ï¼Œ`a1` å’Œ `a2` ç”¨äºä¼ é€’é¢å¤–çš„å‚æ•°ã€‚
>
> ### 4. **è¾“å‡ºå­—ç¬¦**
>
> ```c
> void print_char(char c) {
>     sbi_call(SBI_CONSOLE_PUTCHAR, c, 0, 0);
> }
> ```
>
> è§£é‡Šï¼š
>
> `print_char` å‡½æ•°ç”¨äºè¾“å‡ºä¸€ä¸ªå­—ç¬¦ã€‚å®ƒè°ƒç”¨äº† `sbi_call` å‡½æ•°ï¼Œå°† `SBI_CONSOLE_PUTCHAR` ä½œä¸º `sbi_num`ï¼Œå¹¶å°†å­—ç¬¦ `c` ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆé€šè¿‡ `a0` å¯„å­˜å™¨ä¼ é€’ï¼‰ã€‚`arg1` å’Œ `arg2` è¢«è®¾ç½®ä¸º 0ï¼Œå› ä¸ºå­—ç¬¦è¾“å‡ºä¸éœ€è¦é¢å¤–çš„å‚æ•°ã€‚
>
> ### 5. **è¾“å‡ºå­—ç¬¦ä¸²**
>
> ```c
> void print_string(const char* str) {
>     while (*str) {
>         print_char(*str++);
>     }
> }
> ```
>
> è§£é‡Šï¼š
>
> `print_string` å‡½æ•°ç”¨äºè¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å®ƒé€šè¿‡æŒ‡é’ˆ `str` éå†å­—ç¬¦ä¸²çš„æ¯ä¸ªå­—ç¬¦ï¼Œè°ƒç”¨ `print_char` è¾“å‡ºæ¯ä¸ªå­—ç¬¦ï¼Œç›´åˆ°é‡åˆ°å­—ç¬¦ä¸²æœ«å°¾çš„ç©ºå­—ç¬¦ï¼ˆ`'\0'`ï¼‰ã€‚æ¯æ¬¡è¾“å‡ºä¸€ä¸ªå­—ç¬¦åï¼Œ`str++` ä½¿æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚
>
> ### 6. **ä¸»å‡½æ•°**
>
> ```c
> int main() {
>     print_string("Hello, World! x10 (fake)\n");
>     while (1) {} // æ— é™å¾ªç¯ï¼Œé˜²æ­¢ç¨‹åºé€€å‡º
>     return 0;
> }
> ```
>
> è§£é‡Šï¼š
>
> 1. **å­—ç¬¦ä¸²è¾“å‡º**ï¼š`main` å‡½æ•°ä¸­è°ƒç”¨äº† `print_string`ï¼Œè¾“å‡ºå­—ç¬¦ä¸² `"Hello, World! x10 (fake)\n"` åˆ°æ§åˆ¶å°ã€‚
>
> 2. **æ— é™å¾ªç¯**ï¼š`while (1) {}` æ˜¯ä¸€ä¸ªç©ºçš„æ— é™å¾ªç¯ï¼Œç”¨äºé˜²æ­¢ç¨‹åºåœ¨è¾“å‡ºå®Œæˆåé€€å‡ºã€‚è¿™æ˜¯å› ä¸ºåœ¨è£¸æœºç¯å¢ƒä¸­ï¼Œæ²¡æœ‰æ“ä½œç³»ç»Ÿç®¡ç†ç¨‹åºçš„é€€å‡ºè¡Œä¸ºã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªå¾ªç¯ï¼Œç¨‹åºä¼šç»§ç»­æ‰§è¡Œåˆ°æœªå®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œå¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸ºç”šè‡³å´©æºƒã€‚
>

å°†`hello.c`å†…å®¹æ›¿æ¢ä¸ºä»¥ä¸Šä¸ä½¿ç”¨æ ‡å‡†åº“çš„ Hello World C ä»£ç ï¼Œå†æ¬¡å°è¯•ç¼–è¯‘ï¼š

```bash
riscv64-unknown-elf-gcc -g -o hello hello.c
```

> ### æŠ¥é”™2ï¼šè¿˜æ˜¯æŠ¥é”™ï¼šæ‰¾ä¸åˆ°`crt0.o`ã€`-lc` å’Œ `-lgcc`
>
> ![QQ_1727414877837](../assets/QQ_1727414877837.png)

## å››ã€ä¸ä½¿ç”¨é»˜è®¤çš„å¯åŠ¨ä»£ç 

`crt0.o`ã€`-lc` å’Œ `-lgcc` æ˜¯ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šå¸¸åœ¨æ“ä½œç³»ç»Ÿç¯å¢ƒä¸‹ä½¿ç”¨ã€‚åœ¨è£¸æœºç¼–ç¨‹ç¯å¢ƒä¸­ï¼Œç¼–è¯‘å™¨æŠ¥é”™æ‰¾ä¸åˆ°è¿™äº›æ–‡ä»¶æˆ–åº“ï¼ŒåŸå› è¿˜æ˜¯è£¸æœºç¼–ç¨‹çš„ç¯å¢ƒä¸æ“ä½œç³»ç»Ÿæ”¯æŒçš„ç¯å¢ƒæˆªç„¶ä¸åŒã€‚

### 1. **`crt0.o`ï¼ˆC Runtime Object Fileï¼‰**

`crt0.o` æ˜¯ C è¯­è¨€è¿è¡Œæ—¶åº“ï¼ˆC runtimeï¼‰çš„**å¯åŠ¨ä»£ç **ï¼ˆC runtime startup codeï¼‰ã€‚å®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡æ–‡ä»¶ï¼Œé€šå¸¸åœ¨é“¾æ¥é˜¶æ®µè¢«åŒ…å«è¿›ç¨‹åºï¼Œç”¨äºä¸º C è¯­è¨€ç¨‹åºçš„è¿è¡Œåšå‡†å¤‡ã€‚å®ƒçš„ä¸»è¦èŒè´£æ˜¯ï¼š

- è®¾ç½®ç¨‹åºçš„å…¥å£ç‚¹ï¼ˆé€šå¸¸æ˜¯ `_start`ï¼‰ã€‚
- åˆå§‹åŒ–å…¨å±€å’Œé™æ€å˜é‡ã€‚
- è°ƒç”¨ `main` å‡½æ•°ã€‚
- ç¨‹åºé€€å‡ºæ—¶æ‰§è¡Œæ¸…ç†æ“ä½œã€‚

#### åœ¨æ“ä½œç³»ç»Ÿä¸­çš„è§’è‰²

åœ¨æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Linuxï¼‰ä¸Šï¼Œ`crt0.o` ä¼šåšå¦‚ä¸‹å·¥ä½œï¼š

- è®¾ç½®æ ˆæŒ‡é’ˆã€‚
- åˆå§‹åŒ– `.bss` å’Œ `.data` æ®µã€‚
- è°ƒç”¨æ“ä½œç³»ç»Ÿæä¾›çš„åŠ¨æ€é“¾æ¥å™¨ï¼ŒåŠ è½½å…±äº«åº“ã€‚
- æœ€åè°ƒç”¨ `main` å‡½æ•°ã€‚

#### åœ¨è£¸æœºç¼–ç¨‹ä¸­çš„é—®é¢˜

åœ¨è£¸æœºç¼–ç¨‹ä¸­ï¼Œæ²¡æœ‰æ“ä½œç³»ç»Ÿå’ŒåŠ¨æ€é“¾æ¥å™¨ï¼Œä¹Ÿä¸éœ€è¦æ“ä½œç³»ç»Ÿæä¾›çš„åˆå§‹åŒ–å·¥ä½œã€‚å› æ­¤ï¼Œè£¸æœºç¨‹åºé€šå¸¸è‡ªè¡Œç¼–å†™å¯åŠ¨ä»£ç ï¼Œæ‰‹åŠ¨è®¾ç½®æ ˆæŒ‡é’ˆã€åˆå§‹åŒ– `.bss` å’Œ `.data` æ®µç­‰å·¥ä½œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨è£¸æœºç¯å¢ƒä¸‹ä¸éœ€è¦ `crt0.o`ï¼Œå¹¶ä¸”ä¼šæŠ¥é”™æ‰¾ä¸åˆ°å®ƒã€‚ä½ éœ€è¦**æä¾›è‡ªå·±ä¸“é—¨çš„å¯åŠ¨æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯æ±‡ç¼–ä»£ç ï¼‰**æ¥æ›¿ä»£ `crt0.o` çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸€ä¸ª `start.s` æ–‡ä»¶ã€‚

### 2. **`-lc`ï¼ˆC Standard Libraryï¼‰**

`-lc` æ˜¯æŒ‡é“¾æ¥**æ ‡å‡† C åº“**ï¼ˆ`libc`ï¼‰ã€‚C æ ‡å‡†åº“æä¾›äº†è®¸å¤šåŸºæœ¬çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š

- è¾“å…¥è¾“å‡ºï¼ˆ`printf`ã€`scanf` ç­‰ï¼‰ã€‚
- å­—ç¬¦ä¸²å¤„ç†ï¼ˆ`strlen`ã€`strcpy` ç­‰ï¼‰ã€‚
- æ•°å­¦è¿ç®—ï¼ˆ`sin`ã€`cos` ç­‰ï¼‰ã€‚

#### åœ¨æ“ä½œç³»ç»Ÿä¸­çš„è§’è‰²

åœ¨æœ‰æ“ä½œç³»ç»Ÿæ”¯æŒçš„ç¯å¢ƒä¸­ï¼ŒC æ ‡å‡†åº“ä¾èµ–æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨æ¥å®ç°è®¸å¤šåŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œ`printf` å‡½æ•°é€šè¿‡ç³»ç»Ÿè°ƒç”¨å°†å­—ç¬¦ä¸²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè€Œæ–‡ä»¶æ“ä½œã€å†…å­˜åˆ†é…ç­‰åŠŸèƒ½ä¹Ÿéƒ½ä¾èµ–æ“ä½œç³»ç»Ÿçš„æ”¯æŒã€‚

#### åœ¨è£¸æœºç¼–ç¨‹ä¸­çš„é—®é¢˜

è£¸æœºç¼–ç¨‹æ²¡æœ‰æ“ä½œç³»ç»Ÿï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿã€ç»ˆç«¯æˆ–æ§åˆ¶å°ç­‰èµ„æºä¾›æ ‡å‡† C åº“è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œè£¸æœºç¨‹åºæ— æ³•è°ƒç”¨ `printf`ï¼Œå› ä¸ºæ²¡æœ‰æ“ä½œç³»ç»Ÿæä¾›çš„è¾“å…¥è¾“å‡ºè®¾å¤‡æ”¯æŒã€‚æ‰€ä»¥åœ¨è£¸æœºç¼–ç¨‹ä¸­ï¼Œæ ‡å‡† C åº“æ˜¯æ— ç”¨çš„ï¼Œé“¾æ¥ `-lc` ä¼šå¯¼è‡´é”™è¯¯ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè£¸æœºç¼–ç¨‹é€šå¸¸éœ€è¦è‡ªå·±ç¼–å†™æˆ–è€…ä½¿ç”¨ç‰¹å®šçš„åº“æ¥æ›¿ä»£éƒ¨åˆ† `libc` çš„åŠŸèƒ½ï¼Œæ¯”å¦‚é€šè¿‡è®¿é—®ç¡¬ä»¶å¯„å­˜å™¨æˆ–ä½¿ç”¨ `SBI` æ¥å®ç°å­—ç¬¦è¾“å‡ºã€‚ä½ ä¸èƒ½ç›´æ¥ä½¿ç”¨æ“ä½œç³»ç»Ÿä¾èµ–çš„ `libc`ï¼Œè€Œæ˜¯éœ€è¦ä¸ºè£¸æœºç¯å¢ƒå®šåˆ¶è¾“å‡ºã€å†…å­˜ç®¡ç†ç­‰åŸºæœ¬åŠŸèƒ½ã€‚

### 3. **`-lgcc`ï¼ˆGCC Low-Level Runtime Libraryï¼‰**

`-lgcc` æ˜¯ GCC ç¼–è¯‘å™¨çš„è¿è¡Œæ—¶æ”¯æŒåº“ã€‚å®ƒåŒ…å«äº†ä¸€äº› GCC ç¼–è¯‘å™¨ç”Ÿæˆä»£ç æ—¶æ‰€éœ€è¦çš„åº•å±‚å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œå®ƒæä¾›äº†æ•´æ•°é™¤æ³•ã€æµ®ç‚¹è¿ç®—ç­‰åŸºæœ¬åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½åœ¨ç¡¬ä»¶æ²¡æœ‰ç›´æ¥æ”¯æŒæ—¶éœ€è¦é€šè¿‡è½¯ä»¶å®ç°ã€‚

#### åœ¨æ“ä½œç³»ç»Ÿä¸­çš„è§’è‰²

åœ¨æ“ä½œç³»ç»Ÿç¯å¢ƒä¸‹ï¼Œ`-lgcc` è´Ÿè´£æä¾›ä¸€äº›åŸºæœ¬çš„ä½çº§å‡½æ•°ï¼Œä½†é€šå¸¸ä¸æ ‡å‡† C åº“å’Œæ“ä½œç³»ç»Ÿå¯†åˆ‡ç»“åˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç éœ€è¦é™¤æ³•æ“ä½œè€Œç›®æ ‡å¤„ç†å™¨ä¸æ”¯æŒç›´æ¥çš„ç¡¬ä»¶é™¤æ³•æŒ‡ä»¤ï¼Œ`-lgcc` ä¸­çš„å‡½æ•°å°†ä¸ºå…¶æä¾›æ”¯æŒã€‚

#### åœ¨è£¸æœºç¼–ç¨‹ä¸­çš„é—®é¢˜

åœ¨è£¸æœºç¼–ç¨‹ç¯å¢ƒä¸­ï¼Œå¦‚æœå°è¯•é“¾æ¥ `-lgcc` è€Œæ²¡æœ‰æä¾›å¿…è¦çš„åº•å±‚æ”¯æŒåº“æˆ–ç¼–è¯‘å™¨çš„å®Œæ•´é…ç½®ï¼Œå¯èƒ½ä¼šé‡åˆ°é“¾æ¥å™¨é”™è¯¯ã€‚è™½ç„¶ `-lgcc` ä½œä¸ºåº•å±‚åº“é€šå¸¸å¯ä»¥ç”¨äºè£¸æœºç¯å¢ƒï¼Œä½†å…¶åŠŸèƒ½å¿…é¡»ä¸è£¸æœºçš„éœ€æ±‚ç›¸åŒ¹é…ã€‚å¦‚æœç¼–è¯‘å™¨é…ç½®ä¸å®Œæ•´æˆ–è€…å·¥å…·é“¾ä¸æ”¯æŒè£¸æœºç¯å¢ƒï¼Œå¯èƒ½å¯¼è‡´æ‰¾ä¸åˆ° `-lgcc`ï¼Œä»è€ŒæŠ¥é”™ã€‚

è£¸æœºç¨‹åºé€šå¸¸ä¸ä¾èµ–äºå®Œæ•´çš„ GCC è¿è¡Œæ—¶æ”¯æŒåº“ï¼Œå°¤å…¶æ˜¯åœ¨ç¼–è¯‘å™¨å·²ç»ç”Ÿæˆé€‚åˆè£¸æœºçš„ä»£ç æ—¶ã€‚ä½ å¯ä»¥æ‰‹åŠ¨å®ç°ä¸€äº›å…³é”®çš„ä½çº§åŠŸèƒ½ï¼Œä¾‹å¦‚é€šè¿‡ç›´æ¥ä½¿ç”¨ç¡¬ä»¶æŒ‡ä»¤æ¥è¿›è¡Œé™¤æ³•æˆ–è€…æµ®ç‚¹æ•°è¿ç®—ï¼Œè€Œä¸æ˜¯ä¾èµ– `-lgcc` æä¾›çš„è¿™äº›å‡½æ•°ã€‚

### æ€»çš„æ¥è¯´

- è£¸æœºç¨‹åºå¿…é¡»æ‰‹åŠ¨æä¾›**å¯åŠ¨ä»£ç **å’Œè¿è¡Œæ—¶æ”¯æŒã€‚è¿™æ„å‘³ç€ç¨‹åºå‘˜éœ€è¦å®ç°ç±»ä¼¼ `crt0.o` çš„åŠŸèƒ½ï¼ˆå¦‚æ ˆæŒ‡é’ˆè®¾ç½®ã€å…¨å±€å˜é‡åˆå§‹åŒ–ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯ä¾èµ– C è¿è¡Œæ—¶ç¯å¢ƒã€‚
- è£¸æœºç¨‹åºé€šå¸¸ä¸ä¼šä½¿ç”¨å®Œæ•´çš„ C æ ‡å‡†åº“ï¼Œè€Œæ˜¯ä½¿ç”¨ç‰¹å®šçš„åº“æˆ–è€…ç›´æ¥æ“ä½œç¡¬ä»¶æ¥å®ç°å¿…è¦çš„åŠŸèƒ½ã€‚

### å¯åŠ¨ä»£ç ï¼ˆStartup Codeï¼‰çš„ä½œç”¨

1. **ç¡¬ä»¶åˆå§‹åŒ–**ï¼šåœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå¿…é¡»æ‰‹åŠ¨åˆå§‹åŒ–ç¡¬ä»¶èµ„æºï¼Œä¾‹å¦‚è®¾ç½®å †æ ˆæŒ‡é’ˆï¼ˆ`sp`ï¼‰ï¼Œåˆå§‹åŒ– `.bss` æ®µï¼ˆå­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€å˜é‡ï¼‰ï¼Œè®¾ç½®æ—¶é’Ÿç­‰ç¡¬ä»¶å¤–è®¾ã€‚
2. **ç¨‹åºå…¥å£è®¾ç½®**ï¼šå¯åŠ¨ä»£ç æä¾›äº†ç¨‹åºçš„å…¥å£ç‚¹ï¼Œé€šå¸¸æ˜¯ `_start`ï¼Œå®ƒæ˜¯è£¸æœºç¨‹åºçš„æ‰§è¡Œèµ·ç‚¹ã€‚å¯åŠ¨ä»£ç ä¼šè°ƒç”¨ `main` å‡½æ•°ï¼Œä½¿ C ä»£ç èƒ½å¤Ÿå¼€å§‹æ‰§è¡Œã€‚
3. **é˜²æ­¢ç¨‹åºå¼‚å¸¸è¿”å›**ï¼šåœ¨è£¸æœºç¨‹åºä¸­ï¼Œæ²¡æœ‰æ“ä½œç³»ç»Ÿæ¥æ¥ç®¡ç¨‹åºé€€å‡ºåçš„è¡Œä¸ºã€‚å¯åŠ¨ä»£ç é€šå¸¸åœ¨ `main` å‡½æ•°ç»“æŸåè¿›å…¥æ— é™å¾ªç¯ï¼Œé¿å…ç¨‹åºè¿è¡Œåˆ°æœªå®šä¹‰åŒºåŸŸã€‚

ä¸‹é¢ï¼Œä¸ºäº†åœ¨è£¸æœºç¯å¢ƒä¸‹æˆåŠŸç¼–è¯‘ï¼Œå¿…é¡»å‘Šè¯‰é“¾æ¥å™¨ä¸è¦ä½¿ç”¨é»˜è®¤çš„ C è¿è¡Œæ—¶å¯åŠ¨æ–‡ä»¶ï¼ˆ`crt0.o`ï¼‰å’Œæ ‡å‡†åº“ï¼ˆ`libc`ï¼‰ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

### ä¿®æ”¹ç¼–è¯‘å‘½ä»¤

ä½ éœ€è¦é€šè¿‡ `-nostartfiles` å’Œ `-nostdlib` å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦é“¾æ¥æ ‡å‡†å¯åŠ¨æ–‡ä»¶å’Œåº“ã€‚

ä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤ç¼–è¯‘ï¼š

```bash
riscv64-unknown-elf-gcc -g -nostartfiles -nostdlib -o hello.elf hello.c
```

- `-nostartfiles`ï¼šä¸ä½¿ç”¨é»˜è®¤çš„ C è¿è¡Œæ—¶å¯åŠ¨æ–‡ä»¶ï¼ˆå¦‚ `crt0.o`ï¼‰ã€‚
- `-nostdlib`ï¼šä¸é“¾æ¥æ ‡å‡†åº“ï¼ˆå¦‚ `libc` å’Œ `libgloss`ï¼‰ã€‚

### æ‰‹åŠ¨æŒ‡å®šå¯åŠ¨æ–‡ä»¶

åœ¨è£¸æœºç¼–ç¨‹ä¸­ï¼Œä½ éœ€è¦**æ‰‹åŠ¨æä¾›å¯åŠ¨ä»£ç **ï¼ˆ`startup`ï¼‰ï¼Œé€šå¸¸è¿™è¢«ç§°ä¸ºå¯åŠ¨æ±‡ç¼–æ–‡ä»¶ `crt0.s` æˆ–ç±»ä¼¼æ–‡ä»¶ï¼Œè´Ÿè´£è®¾ç½®å †æ ˆæŒ‡é’ˆã€æ¸…ç† bss æ®µç­‰ã€‚ä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„å¯åŠ¨ä»£ç æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„è£¸æœº RISC-V å¯åŠ¨æ–‡ä»¶ `start.s`ï¼š

```assembly
# start.s
.globl _start
_start:
    # è®¾ç½®å †æ ˆæŒ‡é’ˆ (sp)
    la sp, _stack_top

    # è·³è½¬åˆ° main å‡½æ•°
    call main

    # æ— é™å¾ªç¯ï¼Œé˜²æ­¢è¿”å›
    1: j 1b
```

è¿™ä¸ªæ–‡ä»¶è®¾ç½®äº†å †æ ˆæŒ‡é’ˆå¹¶è·³è½¬åˆ° `main` å‡½æ•°ã€‚

> ### è¿™ä¸ªæ±‡ç¼–ä»£ç ï¼ˆ`start.s`ï¼‰è®²è§£
>
> ### 1. **`.globl _start`**
>
> ```assembly
> .globl _start
> ```
>
> - **ä½œç”¨**ï¼šè¿™æ˜¯ä¸€ä¸ªæ±‡ç¼–ä¼ªæŒ‡ä»¤ï¼Œå®šä¹‰ç¬¦å· `_start` ä¸ºå…¨å±€ç¬¦å·ï¼Œä½¿å…¶å¯ä»¥åœ¨é“¾æ¥å™¨é˜¶æ®µè¢«å…¶ä»–æ–‡ä»¶ï¼ˆå¦‚é“¾æ¥å™¨è„šæœ¬æˆ–ç¼–è¯‘å™¨ï¼‰å¼•ç”¨ã€‚å…¨å±€ç¬¦å·çš„ä½œç”¨æ˜¯å‘Šè¯‰é“¾æ¥å™¨ï¼Œç¨‹åºçš„å…¥å£ç‚¹åœ¨è¿™ä¸ªæ ‡ç­¾ `_start`ã€‚
>
> - **ç¨‹åºå…¥å£**ï¼šåœ¨è£¸æœºç¼–ç¨‹ä¸­ï¼Œç¨‹åºä¸ä¼šåƒåœ¨æ“ä½œç³»ç»Ÿç¯å¢ƒä¸­é‚£æ ·è‡ªåŠ¨æ‰¾åˆ° `main` å‡½æ•°ä½œä¸ºå…¥å£ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ç¨‹åºä» `_start` æ ‡ç­¾å¼€å§‹æ‰§è¡Œã€‚é“¾æ¥å™¨è„šæœ¬ä¸­çš„ `ENTRY(_start)` å°±æŒ‡å®šç¨‹åºä»è¿™ä¸ªæ ‡ç­¾å¼€å§‹æ‰§è¡Œã€‚
>
> ### 2. **`_start:`**
>
> ```assembly
> _start:
> ```
>
> - **æ ‡ç­¾**ï¼šè¿™æ˜¯ä¸€ä¸ªæ±‡ç¼–æ ‡ç­¾ï¼Œè¡¨ç¤ºä»£ç æ‰§è¡Œçš„èµ·å§‹ä½ç½®ã€‚è¿™é‡Œçš„ `_start` å°±æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ï¼Œç¨‹åºæ‰§è¡Œä»è¿™é‡Œå¼€å§‹ã€‚é€šè¿‡é“¾æ¥å™¨è„šæœ¬å°† `_start` è®¾ç½®ä¸ºç¨‹åºå…¥å£ï¼Œæœºå™¨åœ¨å¤ä½åæˆ–ä¸Šç”µå¯åŠ¨åä¼šä»è¿™é‡Œå¼€å§‹æ‰§è¡ŒæŒ‡ä»¤ã€‚
>
> ### 3. **è®¾ç½®å †æ ˆæŒ‡é’ˆï¼ˆ`la sp, _stack_top`ï¼‰**
>
> ```assembly
> la sp, _stack_top
> ```
>
> - **è§£é‡Š**ï¼š`la` æ˜¯ `load address` çš„ç¼©å†™ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°† `_stack_top` çš„åœ°å€åŠ è½½åˆ° `sp` å¯„å­˜å™¨ä¸­ã€‚`sp` å¯„å­˜å™¨æ˜¯ RISC-V æ¶æ„ä¸­å­˜æ”¾å †æ ˆæŒ‡é’ˆï¼ˆstack pointerï¼‰çš„å¯„å­˜å™¨ã€‚
>
> - **ä½œç”¨**ï¼šç¨‹åºè¿è¡Œæ—¶ï¼Œå †æ ˆï¼ˆstackï¼‰ç”¨äºå­˜å‚¨å‡½æ•°è°ƒç”¨æ—¶çš„è¿”å›åœ°å€ã€å±€éƒ¨å˜é‡ã€ä¿å­˜å¯„å­˜å™¨çŠ¶æ€ç­‰ã€‚`sp` å¯„å­˜å™¨æŒ‡å‘å †æ ˆçš„æ ˆé¡¶ã€‚è¿™é‡Œå°† `_stack_top` çš„åœ°å€è®¾ç½®ä¸ºæ ˆé¡¶åœ°å€ï¼Œè¡¨ç¤ºä»è¯¥åœ°å€å¼€å§‹å‘ä¸‹å¢é•¿å­˜å‚¨æ•°æ®ã€‚
>
>   å †æ ˆé€šå¸¸å‘ä½åœ°å€æ–¹å‘å¢é•¿ï¼Œå› æ­¤ `_stack_top` è®¾ç½®ä¸ºæŸä¸ªé«˜åœ°å€ä½ç½®ï¼Œä»¥ç¡®ä¿å †æ ˆæœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥å­˜å‚¨æ•°æ®ã€‚
>
> - **è£¸æœºç¼–ç¨‹ä¸­çš„ä½œç”¨**ï¼šåœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå †æ ˆæŒ‡é’ˆé€šå¸¸ç”±æ“ä½œç³»ç»Ÿè®¾ç½®ï¼Œä½†åœ¨è£¸æœºç¼–ç¨‹ä¸­ï¼Œå¼€å‘è€…å¿…é¡»æ‰‹åŠ¨è®¾ç½®å †æ ˆæŒ‡é’ˆã€‚åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒä¸­ï¼Œè¿™ä¸€è¡Œä»£ç ç¡®ä¿å‡½æ•°è°ƒç”¨å’Œå±€éƒ¨å˜é‡å¯ä»¥æ­£å¸¸ä½¿ç”¨å †æ ˆã€‚
>
> ### 4. **è·³è½¬åˆ° `main` å‡½æ•°**
>
> ```assembly
> call main
> ```
>
> - **è§£é‡Š**ï¼š`call` æ˜¯ RISC-V çš„è°ƒç”¨æŒ‡ä»¤ï¼Œå®ƒçš„ä½œç”¨æ˜¯è·³è½¬åˆ°æŒ‡å®šå‡½æ•°çš„åœ°å€å¹¶ä¿å­˜å½“å‰çš„è¿”å›åœ°å€ã€‚
>
> - **ä½œç”¨**ï¼šè¿™é‡Œé€šè¿‡ `call main` è·³è½¬åˆ° C è¯­è¨€ä¸­å®šä¹‰çš„ `main` å‡½æ•°ã€‚æ­¤æ—¶ï¼ŒC è¯­è¨€ä»£ç çš„æ‰§è¡Œå¼€å§‹ï¼Œ`main` å‡½æ•°é€šå¸¸åŒ…å«ç¨‹åºçš„ä¸»è¦é€»è¾‘ã€‚
>
> - **`call` æŒ‡ä»¤ç»†èŠ‚**ï¼š
>   - è·³è½¬åˆ° `main` å‡½æ•°ã€‚
>   - å°†å½“å‰æŒ‡ä»¤åœ°å€ï¼ˆå³ `_start` ä½ç½®ï¼‰ä¿å­˜åˆ° `ra` å¯„å­˜å™¨ï¼ˆè¿”å›åœ°å€å¯„å­˜å™¨ï¼‰ï¼Œä»¥ä¾¿ `main` å‡½æ•°æ‰§è¡Œå®Œæˆåèƒ½å¤Ÿè¿”å›ã€‚
>
> - **è£¸æœºç¼–ç¨‹ä¸­çš„è¿”å›é—®é¢˜**ï¼šåœ¨æ“ä½œç³»ç»Ÿç¯å¢ƒä¸­ï¼Œ`main` å‡½æ•°è¿”å›åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†ç¨‹åºå¹¶é€€å‡ºã€‚ä½†åœ¨è£¸æœºç¼–ç¨‹ä¸­ï¼Œæ²¡æœ‰æ“ä½œç³»ç»Ÿç®¡ç†è¿”å›ç‚¹ã€‚å¦‚æœ `main` å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œè£¸æœºç¨‹åºæ— æ³•è¿”å›åˆ°æœ‰æ•ˆçš„åœ°å€ï¼ˆå› ä¸ºæ²¡æœ‰æ“ä½œç³»ç»Ÿæ¥ç®¡ç¨‹åºï¼‰ï¼Œè¿™ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚å› æ­¤ï¼Œé€šå¸¸åœ¨å¯åŠ¨ä»£ç ä¸­ä¼šé˜²æ­¢ç¨‹åºè¿”å›ã€‚
>
> ### 5. **æ— é™å¾ªç¯ï¼ˆ`1: j 1b`ï¼‰**
>
> ```assembly
> 1: j 1b
> ```
>
> - **è§£é‡Š**ï¼š
>   - `1:` æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼Œç”¨äºæ ‡è¯†ä»£ç ä¸­çš„ä½ç½®ã€‚
>   - `j 1b` æ˜¯ä¸€ä¸ªè·³è½¬æŒ‡ä»¤ï¼Œ`1b` è¡¨ç¤ºå‘ä¸Šè·³è½¬åˆ°æ ‡ç­¾ `1`ï¼Œå³å†æ¬¡è·³è½¬åˆ° `1:` çš„ä½ç½®ï¼Œå½¢æˆä¸€ä¸ªæ— é™å¾ªç¯ã€‚
>
> - **ä½œç”¨**ï¼šè¿™ä¸€è¡Œä»£ç ç¡®ä¿ç¨‹åºåœ¨ `main` å‡½æ•°è¿”å›åä¸ä¼šç»§ç»­æ‰§è¡Œåˆ°æœªçŸ¥åŒºåŸŸã€‚å¦‚æœæ²¡æœ‰è¿™è¡Œä»£ç ï¼Œç¨‹åºå¯èƒ½ä¼šç»§ç»­è¿è¡Œåˆ°æœªå®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œå¼•å‘é”™è¯¯æˆ–ç³»ç»Ÿå´©æºƒã€‚
>
> - **è£¸æœºç¨‹åºä¸­çš„å¿…è¦æ€§**ï¼šè£¸æœºç¨‹åºé€šå¸¸æ²¡æœ‰æ˜ç¡®çš„é€€å‡ºæœºåˆ¶ã€‚ä¸ºäº†é˜²æ­¢ç¨‹åºè¿”å›åˆ°æ²¡æœ‰å®šä¹‰çš„åœ°å€åŒºåŸŸï¼Œå¸¸å¸¸ä½¿ç”¨ä¸€ä¸ªæ— é™å¾ªç¯æ¥ä¿è¯ç¨‹åºåœç•™åœ¨å®‰å…¨çš„å·²çŸ¥ä½ç½®ï¼Œè€Œä¸ä¼šç»§ç»­æ‰§è¡Œæœªå®šä¹‰çš„æŒ‡ä»¤ã€‚é€šè¿‡è¿™ä¸ªæ— é™å¾ªç¯ï¼Œç¨‹åºä¼šä¿æŒæ‰§è¡ŒçŠ¶æ€ï¼Œç›´åˆ°ç¡¬ä»¶ç³»ç»Ÿè¢«å¤ä½æˆ–é‡å¯ã€‚
>

### é‡æ–°ç¼–è¯‘

åœ¨å½“å‰ç›®å½•ä¸‹æ·»åŠ `start.s`å¯åŠ¨æ–‡ä»¶åï¼Œå°†å¯åŠ¨æ–‡ä»¶ä¸ç¨‹åºä¸€èµ·ç¼–è¯‘ï¼š

```bash
riscv64-unknown-elf-gcc -g -nostartfiles -nostdlib -o hello.elf start.s hello.c
```

> ### æŠ¥é”™3ï¼šåˆæŠ¥é”™äº† ä½ æ˜¯ä¸æ˜¯æ•…æ„çš„ ğŸ˜ 
>
> ![QQ_1727416352964](../assets/QQ_1727416352964.png)

## äº”ã€ä½¿ç”¨é“¾æ¥è„šæœ¬

ä¸Šé¢çš„é”™è¯¯æç¤ºè¯´æ˜äº†ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨å¯åŠ¨æ–‡ä»¶ `start.s`ä¸­ä½¿ç”¨çš„ `_stack_top` è¿™ä¸ªç¬¦å·æ²¡æœ‰å®šä¹‰ã€‚`_stack_top` é€šå¸¸æ˜¯ç”¨æ¥è¡¨ç¤ºå †æ ˆé¡¶çš„åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€éœ€è¦åœ¨é“¾æ¥è„šæœ¬ä¸­å®šä¹‰æˆ–åœ¨ç¨‹åºä¸­æŒ‡å®šã€‚

### é“¾æ¥è„šæœ¬ï¼ˆLinker Scriptï¼‰çš„ä½œç”¨

1. **å†…å­˜å¸ƒå±€æ§åˆ¶**ï¼šé“¾æ¥è„šæœ¬è´Ÿè´£å°†ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ï¼ˆä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆç­‰ï¼‰åˆ†é…åˆ°æ­£ç¡®çš„å†…å­˜åœ°å€ã€‚è£¸æœºç¨‹åºæ— æ³•ä¾èµ–æ“ä½œç³»ç»Ÿåˆ†é…å†…å­˜ï¼Œæ‰€ä»¥å¿…é¡»é€šè¿‡é“¾æ¥è„šæœ¬æ‰‹åŠ¨æŒ‡å®šç¨‹åºçš„å†…å­˜å¸ƒå±€ã€‚
2. **å®šä¹‰ç¨‹åºå…¥å£**ï¼šé“¾æ¥è„šæœ¬å‘Šè¯‰ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ç¨‹åºçš„å…¥å£ç‚¹ï¼Œä¾‹å¦‚ `_start`ã€‚è¿™æ ·ç¼–è¯‘å™¨èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«å¯åŠ¨ä»£ç çš„ä½ç½®ã€‚
3. **æ§åˆ¶æ®µçš„å¸ƒå±€**ï¼šé“¾æ¥è„šæœ¬æ§åˆ¶ `.text`ï¼ˆä»£ç æ®µï¼‰ã€`.data`ï¼ˆåˆå§‹åŒ–æ•°æ®æ®µï¼‰ã€`.bss`ï¼ˆæœªåˆå§‹åŒ–æ•°æ®æ®µï¼‰ç­‰æ®µåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œç¡®ä¿å®ƒä»¬ä¸äº’ç›¸é‡å å¹¶ä¸”æ­£ç¡®å¯¹é½ï¼Œä»¥ä¾¿è£¸æœºç¨‹åºæ­£å¸¸è¿è¡Œã€‚

> ### å¯åŠ¨ä»£ç ã€é“¾æ¥è„šæœ¬ä¸ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨
>
> å¯åŠ¨ä»£ç ã€é“¾æ¥è„šæœ¬ä¸ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ç´§å¯†å…³è”ï¼Œå®ƒä»¬åœ¨ç¨‹åºçš„ç¼–è¯‘ã€é“¾æ¥ä»¥åŠæ‰§è¡Œè¿‡ç¨‹ä¸­å„è‡ªæ‰¿æ‹…ä¸åŒçš„èŒè´£ï¼Œå…±åŒç¡®ä¿è£¸æœºç¨‹åºå¯ä»¥æ­£ç¡®è¿è¡Œã€‚
>
> ### 1. **ç¼–è¯‘å™¨çš„è§’è‰²**
>
> ç¼–è¯‘å™¨ï¼ˆå¦‚ `gcc`ã€`clang`ï¼‰çš„ä¸»è¦ä»»åŠ¡æ˜¯å°†é«˜çº§è¯­è¨€ï¼ˆå¦‚ Cã€C++ï¼‰ä»£ç ç¼–è¯‘æˆæ±‡ç¼–ä»£ç æˆ–æœºå™¨ç ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨åªè´Ÿè´£å°†å•ä¸ªæºæ–‡ä»¶ç¿»è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼ˆ`.o` æ–‡ä»¶ï¼‰ï¼Œä½†ç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“ç¨‹åºçš„å…¥å£ç‚¹ã€å†…å­˜å¸ƒå±€ç­‰ç³»ç»Ÿçº§ä¿¡æ¯ã€‚ç¼–è¯‘å™¨çš„ä½œç”¨å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š
>
> - **ç¼–è¯‘ C ä»£ç **ï¼šå°† C æ–‡ä»¶ï¼ˆå¦‚ `main.c`ï¼‰è½¬æ¢æˆç›®æ ‡æ–‡ä»¶ï¼ˆ`.o` æ–‡ä»¶ï¼‰ï¼Œè¿™ä¸ªæ–‡ä»¶åªåŒ…å«æœºå™¨ç ï¼Œå¹¶æœªåŒ…å«ç¨‹åºå¦‚ä½•åŠ è½½å’Œæ‰§è¡Œçš„ä¿¡æ¯ã€‚
> - **å¼•å…¥æ±‡ç¼–ä»£ç **ï¼šç¼–è¯‘å™¨ä¹Ÿå¯ä»¥å°†æ±‡ç¼–æ–‡ä»¶ï¼ˆå¦‚ `start.s`ï¼‰ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é€šå¸¸åŒ…å«ç¨‹åºçš„å¯åŠ¨é€»è¾‘ï¼Œå¦‚è®¾ç½®å †æ ˆæŒ‡é’ˆã€è°ƒç”¨ `main` å‡½æ•°ç­‰ã€‚
>
> ### 2. **å¯åŠ¨ä»£ç ä¸ç¼–è¯‘å™¨çš„å…³ç³»**
>
> å¯åŠ¨ä»£ç ï¼ˆé€šå¸¸æ˜¯æ±‡ç¼–æ–‡ä»¶ï¼Œå¦‚ `start.s`ï¼‰å‘Šè¯‰ç¼–è¯‘å™¨ç¨‹åºä»å“ªé‡Œå¼€å§‹æ‰§è¡Œï¼Œå¦‚ä½•åˆå§‹åŒ–ç¯å¢ƒã€‚å®ƒä½œä¸ºä¸€ä¸ªæºæ–‡ä»¶ç”±ç¼–è¯‘å™¨å¤„ç†ï¼Œå°†å…¶è½¬æ¢ä¸ºç›®æ ‡æ–‡ä»¶ã€‚
>
> å¯åŠ¨ä»£ç ä¸ç¼–è¯‘å™¨çš„å…³ç³»ï¼š
>
> - å¯åŠ¨ä»£ç æä¾›ç¨‹åºçš„å…¥å£ç‚¹ï¼Œä¾‹å¦‚ `_start`ã€‚è¿™ä¸ªå…¥å£ç‚¹æ˜¯ç¼–è¯‘å™¨éœ€è¦çŸ¥é“çš„ï¼Œç”¨äºå°†æœºå™¨æŒ‡ä»¤æ±‡ç¼–æˆç›®æ ‡æ–‡ä»¶ã€‚
> - å¯åŠ¨ä»£ç ä¸­è®¾ç½®çš„å †æ ˆæŒ‡é’ˆï¼ˆ`sp`ï¼‰ã€å…¨å±€å˜é‡åˆå§‹åŒ–ç­‰éƒ½æ˜¯ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶çš„å¿…è¦æ­¥éª¤ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¾èµ–äºè¿™äº›åˆå§‹åŒ–æ“ä½œã€‚
>
> ### 3. **é“¾æ¥å™¨çš„è§’è‰²**
>
> é“¾æ¥å™¨ï¼ˆå¦‚ `ld`ï¼‰çš„ä»»åŠ¡æ˜¯å°†å¤šä¸ªç›®æ ‡æ–‡ä»¶ï¼ˆç¼–è¯‘å™¨ç”Ÿæˆçš„ `.o` æ–‡ä»¶ï¼‰åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚ `.elf` æ–‡ä»¶ï¼‰ï¼Œå¹¶è§£å†³æ‰€æœ‰ç¬¦å·å¼•ç”¨ã€‚é“¾æ¥å™¨çš„èŒè´£åŒ…æ‹¬ï¼š
>
> - **ç¬¦å·è§£æ**ï¼šé“¾æ¥å™¨å°†ä¸åŒç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·ï¼ˆå¦‚å‡½æ•°åã€å˜é‡åï¼‰è¿›è¡Œè§£æå’ŒåŒ¹é…ï¼Œç¡®ä¿å‡½æ•°è°ƒç”¨å’Œæ•°æ®è®¿é—®éƒ½æŒ‡å‘æ­£ç¡®çš„åœ°å€ã€‚
> - **å†…å­˜å¸ƒå±€æ§åˆ¶**ï¼šé“¾æ¥å™¨æ ¹æ®é“¾æ¥è„šæœ¬æä¾›çš„æŒ‡ä»¤ï¼Œå°†ä»£ç æ®µã€æ•°æ®æ®µç­‰æ”¾ç½®åˆ°æ­£ç¡®çš„å†…å­˜åœ°å€ã€‚
>
> ### 4. **é“¾æ¥è„šæœ¬ä¸é“¾æ¥å™¨çš„å…³ç³»**
>
> é“¾æ¥è„šæœ¬ï¼ˆå¦‚ `linker.ld`ï¼‰ä¸ºé“¾æ¥å™¨æä¾›ç¨‹åºçš„å†…å­˜å¸ƒå±€ä¿¡æ¯ï¼Œå®ƒæŒ‡å®šäº†ç¨‹åºå„ä¸ªæ®µï¼ˆ`.text`ã€`.data`ã€`.bss` ç­‰ï¼‰åœ¨å†…å­˜ä¸­çš„å…·ä½“ä½ç½®ï¼Œä»¥åŠç¨‹åºå…¥å£ç‚¹ã€‚
>
> é“¾æ¥è„šæœ¬ä¸é“¾æ¥å™¨çš„å…³ç³»ï¼š
>
> - **å†…å­˜å¸ƒå±€æ§åˆ¶**ï¼šé“¾æ¥è„šæœ¬å‘Šè¯‰é“¾æ¥å™¨å¦‚ä½•å°†ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ï¼ˆå¦‚ä»£ç æ®µã€æ•°æ®æ®µï¼‰æ˜ å°„åˆ°ç›®æ ‡æœºå™¨çš„ç‰©ç†å†…å­˜åœ°å€ã€‚ä¾‹å¦‚ï¼ŒæŒ‡å®š `.text` æ®µä»å†…å­˜çš„ `0x10000` å¼€å§‹ã€‚
> - **å…¥å£ç‚¹è®¾ç½®**ï¼šé“¾æ¥è„šæœ¬é€šå¸¸æŒ‡å®šç¨‹åºçš„å…¥å£ç‚¹ï¼Œä¾‹å¦‚ `ENTRY(_start)`ï¼Œå‘Šè¯‰é“¾æ¥å™¨åœ¨ç”Ÿæˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå°†ç¨‹åºä» `_start` å¼€å§‹æ‰§è¡Œã€‚
> - **ç¬¦å·å®šä¹‰**ï¼šé“¾æ¥è„šæœ¬å¯ä»¥å®šä¹‰ä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œå¦‚æ ˆé¡¶ï¼ˆ`_stack_top`ï¼‰çš„ä½ç½®ï¼Œä¾›å¯åŠ¨ä»£ç å’Œé“¾æ¥å™¨ä½¿ç”¨ï¼Œç¡®ä¿æ­£ç¡®çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚
>
> ### 5. **å¯åŠ¨ä»£ç ã€é“¾æ¥è„šæœ¬ä¸ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨çš„æ•´ä½“å…³ç³»**
>
> 1. **ç¼–è¯‘å™¨é˜¶æ®µ**ï¼š
>    - ç¼–è¯‘å™¨å°† C ä»£ç å’Œæ±‡ç¼–ä»£ç åˆ†åˆ«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼ˆ`.o` æ–‡ä»¶ï¼‰ï¼Œå…¶ä¸­å¯åŠ¨ä»£ç çš„æ±‡ç¼–æ–‡ä»¶æä¾›äº†ç¨‹åºçš„å…¥å£ç‚¹ï¼ˆ`_start`ï¼‰ä»¥åŠå †æ ˆæŒ‡é’ˆçš„åˆå§‹åŒ–ã€‚
>    - ç¼–è¯‘å™¨ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰ç»å¯¹çš„åœ°å€ï¼Œå®ƒåªåŒ…å«ç›¸å¯¹åœ°å€å’Œæœªè§£æçš„ç¬¦å·ï¼ˆå¦‚ `main` å‡½æ•°çš„åœ°å€ï¼‰ã€‚
>
> 2. **é“¾æ¥å™¨é˜¶æ®µ**ï¼š
>    - é“¾æ¥å™¨æ¥æ”¶å¤šä¸ªç›®æ ‡æ–‡ä»¶ï¼ˆå¦‚ `start.o` å’Œ `main.o`ï¼‰ï¼Œæ ¹æ®é“¾æ¥è„šæœ¬ä¸­çš„æŒ‡ä»¤ï¼Œå°†ä»£ç æ®µã€æ•°æ®æ®µç­‰æ”¾ç½®åˆ°åˆé€‚çš„å†…å­˜ä½ç½®ï¼Œå¹¶è§£ææ‰€æœ‰æœªå®šä¹‰çš„ç¬¦å·ã€‚
>    - é“¾æ¥è„šæœ¬å‘Šè¯‰é“¾æ¥å™¨ç¨‹åºçš„å…¥å£ç‚¹ã€å„ä¸ªæ®µçš„å¸ƒå±€ï¼ˆå¦‚ `.text`ã€`.data`ã€`.bss` ç­‰ï¼‰ï¼Œå¹¶è®¾ç½®å †æ ˆä½ç½®ç­‰ç‰¹æ®Šç¬¦å·ã€‚
>    - é“¾æ¥å™¨æœ€åç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚ `hello.elf`ï¼‰ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†è£¸æœºç¨‹åºçš„å®Œæ•´å¸ƒå±€å’Œæ‰€æœ‰å·²è§£æçš„ç¬¦å·ã€‚
>
> 3. **ç¨‹åºè¿è¡Œæ—¶**ï¼š
>    - ç¨‹åºä»å¯åŠ¨ä»£ç ï¼ˆ`_start`ï¼‰å¼€å§‹æ‰§è¡Œï¼Œå¯åŠ¨ä»£ç æ ¹æ®é“¾æ¥è„šæœ¬å®šä¹‰çš„å †æ ˆé¡¶åœ°å€ï¼ˆ`_stack_top`ï¼‰è®¾ç½®å †æ ˆæŒ‡é’ˆï¼Œç„¶åè·³è½¬åˆ° `main` å‡½æ•°ã€‚
>    - åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒä¸‹ï¼Œå¯åŠ¨ä»£ç è¿˜è´Ÿè´£åˆå§‹åŒ–å…¨å±€å˜é‡ï¼ˆå¦‚ `.data` æ®µï¼‰ã€æ¸…é›¶ `.bss` æ®µç­‰ã€‚
>

### ä½¿ç”¨é“¾æ¥è„šæœ¬

åœ¨è£¸æœºç¯å¢ƒä¸‹ï¼Œå †æ ˆå’Œå…¶ä»–å†…å­˜åŒºåŸŸçš„åœ°å€é€šå¸¸æ˜¯åœ¨é“¾æ¥è„šæœ¬ï¼ˆ`linker script`ï¼‰ä¸­å®šä¹‰çš„ã€‚ä¸ºäº†è§£å†³é”™è¯¯ï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„é“¾æ¥è„šæœ¬ï¼Œæ‰‹åŠ¨å®šä¹‰å †æ ˆé¡¶çš„åœ°å€ã€‚

1. **ç¼–å†™ä¸€ä¸ªç®€å•çš„é“¾æ¥è„šæœ¬**ï¼Œå¦‚ `linker.ld`ï¼š

```ld
/* linker.ld */
OUTPUT_ARCH(riscv)
ENTRY(_start)   /* è®¾ç½®å…¥å£ç‚¹ä¸º _start */

SECTIONS
{
    . = 0x80000000; /* æŒ‡å®šä»£ç èµ·å§‹åœ°å€ï¼Œå‡è®¾æ”¾åœ¨ 0x80000000 å¤„ */

    .text : {
        *(.text)   /* å°†æ‰€æœ‰ .text æ®µæ”¾åœ¨ .text åŒº */
    }

    .rodata : {
        *(.rodata) /* å°†åªè¯»æ•°æ®æ®µæ”¾åœ¨ .rodata åŒº */
    }

    .data : {
        *(.data)   /* å°† .data æ®µæ”¾åœ¨ .data åŒº */
    }

    .bss : {
        *(.bss)    /* å°† .bss æ®µæ”¾åœ¨ .bss åŒº */
    }

    _stack_top = 0x80010000;  /* å®šä¹‰å †æ ˆé¡¶çš„åœ°å€ */
}
```

è¿™é‡Œå°†å †æ ˆé¡¶å®šä¹‰ä¸º 0x80010000ï¼ˆè¿™ä¸ªåœ°å€å¯ä»¥æ ¹æ®ä½ çš„éœ€æ±‚è°ƒæ•´ï¼‰ã€‚

### åœ¨æ±‡ç¼–æ–‡ä»¶ä¸­å®šä¹‰ `_stack_top`

æˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨ä»£ç ä¸­ï¼Œæ·»åŠ  `_stack_top`çš„åœ°å€ï¼š

```assembly
s
```

æ·»åŠ é“¾æ¥è„šæœ¬`linker.ld`å’Œä¿®æ”¹å¯åŠ¨ä»£ç `start.s`åï¼Œé‡æ–°ç¼–è¯‘ï¼š

```bash
riscv64-unknown-elf-gcc -g -nostartfiles -nostdlib -T linker.ld -o hello.elf start.s hello.c
```

> ä¸ç”¨è¯´è‚¯å®šè¿˜å¾—æŠ¥é”™ğŸ˜Šï¼Œç”šè‡³ç´§è·Ÿç€ä¸¤ä¸ªæŠ¥é”™
>
> å¦å¤–æå‰è¯´ä¸€ä¸‹ï¼Œå¦‚æœ QEMU å¡ä½äº†ï¼Œä½ å¯ä»¥é€šè¿‡ã€ Ctrl + Aï¼Œç„¶åæŒ‰ X ã€‘é€€å‡ºã€‚

## å…­ã€ä¿®å¤æŠ¥é”™ï¼Œå¯åŠ¨QEMU

### æŠ¥é”™4

![QQ_1727420607268](../assets/QQ_1727420607268.png)

è¿™ä¸ªé—®é¢˜é€šè¿‡æ·»åŠ ä½¿ç”¨ `-mcmodel=medany`é€‰é¡¹è§£å†³ã€‚

> è¿™ä¸ªé—®é¢˜ä¸ç”¨æ·±ç©¶ï¼Œæœªæ¥çš„ rust è£¸æœºç¼–ç¨‹æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚
>
> å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œå‚è§[The RISC-V Code Models](https://www.sifive.com/blog/all-aboard-part-4-risc-v-code-models) / [RISC-V Options](https://gcc.gnu.org/onlinedocs/gcc-10.1.0/gcc/RISC-V-Options.html)ã€‚
>
> ç®€å•æ¥è¯´ï¼ŒRISC-V æœ‰ä¸åŒçš„ä»£ç æ¨¡å‹ï¼ˆCode Modelï¼‰æ¥å†³å®šå¦‚ä½•å¤„ç†å†…å­˜åœ°å€çš„èŒƒå›´ï¼š
>
> 1. **`medlow`ï¼ˆé»˜è®¤ï¼‰**ï¼š
>    - å‡è®¾æ‰€æœ‰å…¨å±€æ•°æ®å’Œä»£ç çš„åœ°å€éƒ½åœ¨ä½äº 2GB çš„èŒƒå›´å†…ï¼Œé€šå¸¸æ˜¯ä»åŸºåœ°å€ 0 å¼€å§‹ã€‚
>    - è¿™ç§æ¨¡å‹åªé€‚ç”¨äºå°å‹ç¨‹åºï¼Œå› ä¸ºå®ƒé™åˆ¶äº†å¯è®¿é—®çš„å†…å­˜èŒƒå›´ã€‚
> 2. **`medany`**ï¼š
>    - å…è®¸å…¨å±€æ•°æ®å’Œä»£ç æ”¾ç½®åœ¨å†…å­˜ä¸­çš„**ä»»æ„ä½ç½®**ï¼ˆä¸­é«˜ä½ç½®ï¼‰ï¼Œä¸å±€é™äºä½ 2GB åœ°å€ç©ºé—´ã€‚
>    - è¿™ä¸ªæ¨¡å‹ä½¿ç”¨äº†æ›´å¤šçš„æŒ‡ä»¤æ¥ç¡®ä¿æ•°æ®å’Œä»£ç çš„åœ°å€å¯ä»¥è¢«è®¿é—®ï¼Œè€Œä¸å—é™åˆ¶ã€‚

é‡æ–°ç¼–è¯‘ï¼š

```bash
riscv64-unknown-elf-gcc -g -nostartfiles -nostdlib -T linker.ld -mcmodel=medany -o hello.elf start.s hello.c
```

æˆåŠŸäº†ï¼

![QQ_1727421248835](../assets/QQ_1727421248835.png)

æ¥ä¸‹æ¥æ˜¯ï¼Œ[ä½¿ç”¨ QEMU æ¥æ¨¡æ‹Ÿ RISC-V ç¯å¢ƒå¹¶è¿è¡Œåˆšåˆšç¼–è¯‘çš„ `hello` ç¨‹åº](#2-ä½¿ç”¨-qemu-è¿è¡Œ-risc-v-ç¨‹åº)ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
qemu-system-riscv64 -machine virt -nographic -kernel hello.elf -s -S
```

- **`-machine virt`**ï¼šé€‰æ‹© QEMU ä¸­çš„è™šæ‹Ÿ RISC-V æœºå™¨ã€‚
- **`-nographic`**ï¼šè¡¨ç¤ºä¸ä½¿ç”¨å›¾å½¢ç•Œé¢ï¼Œæ‰€æœ‰è¾“å‡ºé€šè¿‡å½“å‰ç»ˆç«¯å¤„ç†ã€‚
- **`-kernel hello`**ï¼šæŒ‡å®šè¦åŠ è½½å¹¶è¿è¡Œçš„ RISC-V ç¨‹åºã€‚
- **`-s`**ï¼šå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œä¼šåœ¨ç«¯å£ 1234 ä¸Šå¼€å¯ä¸€ä¸ª GDB æœåŠ¡å™¨ã€‚
- **`-S`**ï¼šå‘Šè¯‰ QEMU åœ¨å¯åŠ¨åæš‚åœ CPUï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥è¿æ¥ GDB è¿›è¡Œè°ƒè¯•ï¼Œè€Œä¸ä¼šç«‹å³è¿è¡Œç¨‹åºã€‚

ä¸å‡ºæ„å¤–çš„è¯ï¼ŒQEMU ä¼šå¯åŠ¨ï¼Œä½†å¤„äºæš‚åœçŠ¶æ€ï¼Œç­‰å¾… GDB è¿æ¥ã€‚

å‡ºæ„å¤–çš„è¯ã€‚ã€‚

### æŠ¥é”™5

![QQ_1727421614235](../assets/QQ_1727421614235.png)

ä»é”™è¯¯ä¿¡æ¯æ¥çœ‹ï¼Œ `hello.elf` ç¨‹åºå’Œ QEMU é»˜è®¤åŠ è½½çš„ OpenSBI å›ºä»¶çš„åœ°å€å‘ç”Ÿäº†å†²çªã€‚OpenSBI å›ºä»¶è¢«åŠ è½½åˆ° `0x80000000` åœ°å€ç©ºé—´ï¼Œè€Œ `hello.elf` ç¨‹åºçš„ä»£ç æ®µä¹Ÿä» `0x80000000` å¼€å§‹ï¼Œè¿™å¯¼è‡´äº†åœ°å€é‡å é—®é¢˜ã€‚

### è§£å†³æ–¹æ¡ˆ

#### 1. **ä½¿ç”¨ `-bios none` ç¦ç”¨ OpenSBI å›ºä»¶**

å¦‚æœå½“å‰çš„ç¨‹åºä¸éœ€è¦ä¾èµ– OpenSBI æä¾›çš„æœåŠ¡ï¼ˆä¾‹å¦‚æ‰“å°å­—ç¬¦ç­‰ï¼‰ï¼Œå¯ä»¥é€šè¿‡`-bios none`ç¦ç”¨ QEMU é»˜è®¤åŠ è½½çš„ OpenSBI å›ºä»¶æ¥é¿å…å†²çªï¼š

```bash
qemu-system-riscv64 -machine virt -nographic -bios none -kernel hello.elf -s -S
```

è¿™ä¸ªå‘½ä»¤ä¼šè®© QEMU ä¸åŠ è½½ä»»ä½• BIOS æˆ– OpenSBI å›ºä»¶ï¼Œè€Œç›´æ¥è¿è¡Œä½ è‡ªå·±çš„ `hello.elf` ç¨‹åºã€‚

#### 2. **æ›´æ”¹ç¨‹åºåŠ è½½åœ°å€**

æ˜¾ç„¶æˆ‘ä»¬è¿˜éœ€è¦ OpenSBI çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆå¯ä»¥å°† `hello.elf` ç¨‹åºåŠ è½½åˆ°ä¸åŒçš„å†…å­˜åœ°å€ï¼Œé¿å…å’Œ OpenSBI åœ°å€é‡å ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenSBI å›ºä»¶ä» `0x80000000` åœ°å€åŠ è½½ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `linker.ld` æ–‡ä»¶ä¸­è®¾ç½®ä¸åŒçš„åŠ è½½åœ°å€ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥æŠŠåŠ è½½åœ°å€è®¾ç½®ä¸º `0x80200000` æˆ–è€…æ›´é«˜ï¼š

```ld
/* linker.ld */
OUTPUT_ARCH(riscv)
ENTRY(_start)

SECTIONS
{
    . = 0x80200000;  /* å°†ä»£ç æ®µèµ·å§‹åœ°å€è®¾ç½®ä¸º 0x80200000ï¼Œé¿å…å’Œ OpenSBI åœ°å€å†²çª */

    .text : {
        *(.text)     /* å°†æ‰€æœ‰çš„ .text æ®µæ”¾åœ¨ .text åŒº */
    }

    .rodata : {
        *(.rodata)   /* å°†åªè¯»æ•°æ®æ”¾åœ¨ .rodata åŒº */
    }

    .data : {
        *(.data)     /* å°† .data æ®µæ”¾åœ¨ .data åŒº */
    }

    .bss : {
        *(.bss)      /* å°† .bss æ®µæ”¾åœ¨ .bss åŒº */
    }

    _stack_top = 0x80400000;  /* å®šä¹‰å †æ ˆé¡¶çš„åœ°å€ä¸ºæ›´é«˜çš„åœ°å€ */
}
```

è¿™æ ·ï¼Œç¨‹åºå°±ä¼šè¢«åŠ è½½åˆ° `0x80200000` ä»¥é¿å…ä¸ OpenSBI åœ°å€é‡å ã€‚

#### 3. **æŒ‡å®š OpenSBI å›ºä»¶**

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `-bios` é€‰é¡¹æŒ‡å®šä¸€ä¸ª OpenSBI å›ºä»¶ï¼Œå¹¶è®© QEMUåŠ è½½ä½ çš„ç¨‹åºå’Œ OpenSBIã€‚æ¯”å¦‚ä½ ä¸‹è½½äº†ä¸€ä¸ª OpenSBI å›ºä»¶ `opensbi.elf`ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œï¼š

```bash
qemu-system-riscv64 -machine virt -nographic -bios /path/to/opensbi.elf -kernel hello.elf -s -S
```

è¿™ä¸ªä»¥åå†è¯´ã€‚

æ€»ä¹‹æˆ‘ä»¬é€‰æ‹©äº†è®©ç¨‹åºä¸º OpenSBI è®©è·¯ï¼ŒæŠŠåŠ è½½åœ°å€è®¾ç½®ä¸º `0x80200000`ï¼ŒåŒæ—¶`start.s` æ–‡ä»¶ä¸­çš„æ ˆæŒ‡é’ˆè®¾ç½®ä¹Ÿåº”è¯¥æ ¹æ®æ–°çš„åŠ è½½åœ°å€è¿›è¡Œè°ƒæ•´ã€‚

### æ›´æ–°åçš„ `start.s` æ–‡ä»¶

```
.globl _start
_start:
    # è®¾ç½®å †æ ˆæŒ‡é’ˆ (sp)ï¼Œå°†å…¶è®¾ç½®åœ¨ 0x80400000 ä½ç½®ï¼ˆæ¯”ä»£ç åœ°å€æ›´é«˜ï¼‰
    la sp, _stack_top

    # è·³è½¬åˆ° main å‡½æ•°
    call main

    # æ— é™å¾ªç¯ï¼Œé¿å…ç¨‹åºé€€å‡º
1:  j 1b

.globl _stack_top
_stack_top:
    .word 0x80400000  # å°†æ ˆé¡¶è®¾ç½®åœ¨ 0x80400000 ä½ç½®ï¼ˆé«˜äºä»£ç åŠ è½½åŒºåŸŸï¼‰
```

æ›´æ–°å®Œæ–‡ä»¶åå†æ¬¡è¿è¡ŒQEMUï¼š

```bash
qemu-system-riscv64 -machine virt -nographic -kernel hello.elf -s -S
```

![QQ_1727422796435](../assets/QQ_1727422796435.png)

> æ€ä¹ˆæ²¡ååº”å•Šï¼Œä¸ä¼šè¿˜æœ‰bugå§ï¼Ÿ

å½“ä½ çœ‹åˆ°åªå‰©ä¸‹é—ªåŠ¨çš„å…‰æ ‡ï¼Œåˆ«æ‹…å¿ƒï¼Œæ­å–œä½ å·²ç»å®Œæˆäº†QEMUçš„å¯åŠ¨ğŸ‰ï¼Œæ­£å¦‚å‰é¢å‚æ•°ä»‹ç»çš„é‚£æ ·ï¼š

- **`-machine virt`**ï¼šé€‰æ‹© QEMU ä¸­çš„è™šæ‹Ÿ RISC-V æœºå™¨ã€‚
- **`-nographic`**ï¼šè¡¨ç¤ºä¸ä½¿ç”¨å›¾å½¢ç•Œé¢ï¼Œæ‰€æœ‰è¾“å‡ºé€šè¿‡å½“å‰ç»ˆç«¯å¤„ç†ã€‚
- **`-kernel hello`**ï¼šæŒ‡å®šè¦åŠ è½½å¹¶è¿è¡Œçš„ RISC-V ç¨‹åºã€‚
- **`-s`**ï¼šå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œä¼šåœ¨ç«¯å£ 1234 ä¸Šå¼€å¯ä¸€ä¸ª GDB æœåŠ¡å™¨ã€‚
- **`-S`**ï¼šå‘Šè¯‰ QEMU åœ¨å¯åŠ¨åæš‚åœ CPUï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥è¿æ¥ GDB è¿›è¡Œè°ƒè¯•ï¼Œè€Œä¸ä¼šç«‹å³è¿è¡Œç¨‹åºã€‚

QEMU å·²ç»å¯åŠ¨ï¼Œä½†å¤„äºæš‚åœçŠ¶æ€ï¼Œæ­£åœ¨ç­‰å¾… GDB è¿æ¥ã€‚

## ä¸ƒã€è¿æ¥ GDB è¿›è¡Œè°ƒè¯•

æ¥ä¸‹æ¥çš„æ­¥éª¤æ˜¯è¿æ¥ GDB è¿›è¡Œè°ƒè¯•ã€‚

### ç®€è¦æ­¥éª¤

1. **æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯**ï¼šåœ¨æ–°ç»ˆç«¯ä¸­ï¼Œç¡®ä¿ä½ çš„ç¨‹åºå·²ç»ç¼–è¯‘å¹¶å‡†å¤‡å¥½è¿è¡Œã€‚

2. **å¯åŠ¨ GDB**ï¼šä½¿ç”¨ GDB åŠ è½½ä½ çš„ç¨‹åºã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ç¨‹åºåä¸º `hello`ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š

   ```bash
   riscv64-unknown-elf-gdb hello.elf
   ```

   ![QQ_1727423854709](../assets/QQ_1727423854709.png)

3. **è¿æ¥åˆ° QEMU**ï¼šåœ¨ GDB æç¤ºç¬¦ä¸‹ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤è¿æ¥åˆ° QEMU çš„ GDB æœåŠ¡å™¨ï¼ˆè¿æ¥æˆåŠŸåå°±å’Œä¸Šä¸€èŠ‚ç±»ä¼¼å•¦ï¼‰ï¼š

   ```gdb
   target remote :1234
   ```

   ![QQ_1727424253143](../assets/QQ_1727424253143.png)

4. **è®¾ç½®æ–­ç‚¹ï¼ˆå¯é€‰ï¼‰**ï¼šå¦‚æœä½ æƒ³åœ¨ç¨‹åºçš„æŸä¸ªä½ç½®åœæ­¢æ‰§è¡Œï¼Œå¯ä»¥è®¾ç½®æ–­ç‚¹ï¼Œä¾‹å¦‚ï¼š

   ```gdb
   break main
   ```

5. **å¼€å§‹æ‰§è¡Œç¨‹åº**ï¼šè¾“å…¥ä»¥ä¸‹å‘½ä»¤å¼€å§‹ç¨‹åºçš„æ‰§è¡Œï¼ˆåˆ°æ–­ç‚¹ï¼‰ï¼š

   ```gdb
   continue
   ```

6. **è°ƒè¯•ç¨‹åº**ï¼šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ GDB çš„å„ç§å‘½ä»¤æ¥æŸ¥çœ‹å¯„å­˜å™¨çŠ¶æ€ã€å†…å­˜å†…å®¹ç­‰ã€‚

7. **é€€å‡º GDB**ï¼šå®Œæˆè°ƒè¯•åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é€€å‡º GDBï¼š

   ```gdb
   quit
   ```

### è°ƒè¯•ç»†èŠ‚æ­¥éª¤

è¿æ¥æˆåŠŸå`break main`åœ¨ main å‡½æ•°å…¥å£å¤„è®¾ç½®æ–­ç‚¹ï¼Œ

![QQ_1727424301172](../assets/QQ_1727424301172.png)

`c`å¼€å§‹ç¨‹åºæ‰§è¡Œåˆ°æ–­ç‚¹ã€‚

![QQ_1727424712810](../assets/QQ_1727424712810.png)

å½“å‰å±å¹•å±•ç¤ºäº†ä¸¤ä¸ªçª—å£ï¼Œåˆ†åˆ«æ˜¯è°ƒè¯•çª—å£ï¼ˆå·¦ä¾§ï¼‰å’Œ QEMU ç•Œé¢ï¼ˆå³ä¾§ï¼‰ã€‚

### **å·¦ä¾§ - GDB è°ƒè¯•ç•Œé¢**

- **è°ƒè¯•å·¥å…·**ï¼šè¿™æ˜¯ä½ ä½¿ç”¨ `riscv64-unknown-elf-gdb` å¯åŠ¨çš„è°ƒè¯•ä¼šè¯ã€‚ä½ å·²æˆåŠŸè¿æ¥åˆ°è¿è¡Œåœ¨ QEMU ä¸Šçš„ RISC-V æ¨¡æ‹Ÿå™¨ã€‚
- **æ–­ç‚¹ä¿¡æ¯**ï¼š
  - åœ¨ main å‡½æ•°å…¥å£å¤„è®¾ç½®äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œè¿™ä¸€è¡Œè°ƒç”¨äº† `print_string("Hello, World! x10 (fake)\n");`ã€‚
  - å½“å‰ GDB å·²ç»åœ¨è¿™ä¸ªæ–­ç‚¹åœä½ï¼Œå‘½ä¸­äº†ä¸€æ¬¡ï¼Œå³ç¨‹åºæ‰§è¡Œåˆ°è¿™ä¸€è¡Œæ—¶è¢«æš‚åœã€‚
- **æ±‡ç¼–æŒ‡ä»¤çª—å£**ï¼š
  - æ˜¾ç¤ºäº†å½“å‰ç¨‹åºæ‰§è¡Œä½ç½®å‘¨å›´çš„ RISC-V æ±‡ç¼–æŒ‡ä»¤ã€‚
  - å¯ä»¥çœ‹åˆ° GDB è§£é‡Šçš„æŒ‡ä»¤ï¼Œå¦‚ `addi`ã€`auipc`ã€`jal` ç­‰ï¼Œè¿™äº›æ˜¯ç¼–è¯‘åçš„ç¨‹åºçš„å®é™…æŒ‡ä»¤ï¼Œæ­£åœ¨è¢« QEMU æ¨¡æ‹Ÿå™¨æ‰§è¡Œã€‚
- **å¯„å­˜å™¨ä¿¡æ¯**ï¼š
  - å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€å·²ç»æ˜¾ç¤ºåœ¨è°ƒè¯•ç•Œé¢çš„å·¦ä¸‹è§’éƒ¨åˆ†ã€‚
  - å¯ä»¥çœ‹åˆ° `sp`ã€`ra`ã€`a0` ç­‰å¯„å­˜å™¨çš„å½“å‰å€¼ï¼Œè¡¨æ˜ç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€ã€‚
- **æºç çª—å£**ï¼š
  - å¯ä»¥çœ‹åˆ° C æºç çš„å½“å‰æ‰§è¡Œä½ç½®ï¼Œ`print_string("Hello, World! x10 (fake)\n");` æ­£åœ¨ç­‰å¾…è¢«æ‰§è¡Œã€‚
  - ä¸‹æ–¹æœ‰ä¸€ä¸ªæ— é™å¾ªç¯ `while(1)`ï¼Œç›®çš„æ˜¯é˜²æ­¢ç¨‹åºé€€å‡ºï¼Œè®©ç¨‹åºä¸€ç›´è¿è¡Œã€‚

### **å³ä¾§ - QEMU ç•Œé¢**

- **QEMU å¯åŠ¨è¾“å‡º**ï¼š
  - QEMU æ¨¡æ‹Ÿå™¨å·²ç»å¯åŠ¨ï¼Œå¹¶åŠ è½½äº† OpenSBIï¼ˆSupervisor Binary Interfaceï¼‰ï¼Œç”¨äºåœ¨ QEMU è™šæ‹Ÿæœºä¸Šç®¡ç†ç¡¬ä»¶æŠ½è±¡ã€‚
  - å³ä¾§çª—å£æ˜¾ç¤ºçš„æ˜¯ OpenSBI å¯åŠ¨æ—¶çš„è¾“å‡ºä¿¡æ¯ï¼š
    - OpenSBI çš„ç‰ˆæœ¬ä¸º `0.3`ã€‚
    - å¹³å°åç§°ä¸º `riscv-virtio,qemu`ï¼Œå³ QEMU ä½¿ç”¨çš„ RISC-V è™šæ‹Ÿå¹³å°ã€‚
    - åˆ—å‡ºäº†å¹³å°çš„å„ç§è®¾å¤‡ä¿¡æ¯ï¼Œä¾‹å¦‚å®šæ—¶å™¨ã€IPTï¼ˆä¸­æ–­æ§åˆ¶ï¼‰è®¾å¤‡å’Œ UART æ§åˆ¶å°è®¾å¤‡ã€‚
- **æš‚åœçŠ¶æ€**ï¼š
  - ç”±äº QEMU å¯åŠ¨æ—¶ä½¿ç”¨äº† `-S` å‚æ•°ï¼Œæ¨¡æ‹Ÿå™¨å¯åŠ¨åæš‚åœäº† CPU çš„æ‰§è¡Œã€‚å½“å‰ï¼ŒQEMU å¤„äºç­‰å¾…çŠ¶æ€ï¼Œæ²¡æœ‰æ‰§è¡ŒåŠ è½½çš„ç¨‹åºã€‚
  - ä¸€æ—¦ä½ åœ¨ GDB ä¸­å‘å‡º `continue`ï¼ˆæˆ– `c`ï¼‰å‘½ä»¤ï¼ŒQEMU ä¼šç»§ç»­æ‰§è¡Œç¨‹åºã€‚

`s`è¿›å…¥`print_string`

![QQ_1727425069687](../assets/QQ_1727425069687.png)

`n`è¿è¡Œä¸‹ä¸€æ¡ä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬ä¾æ—§å¿½ç•¥`print_char`è°ƒç”¨`sbi_call`ä»¥åŠåç»­ä¸€ç³»åˆ—çš„å†…éƒ¨çš„å®ç°ï¼Œç»§ç»­`n`è·³è½¬åˆ°ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œ`print_char`å‡½æ•°çš„ä½ç½®ã€‚

è§‚å¯ŸQEMUå‘ç”Ÿäº†ä»€ä¹ˆï¼š

![QQ_1727425280681](../assets/QQ_1727425280681.png)

ç»§ç»­ï¼š

{ 

`n`è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ï¼ˆæˆ–è€…å›è½¦è‡ªåŠ¨ç»§ç»­æ‰§è¡Œä¸Šä¸€æ¡æŒ‡ä»¤ï¼‰

`n`å®Œæˆä¸‹ä¸€æ¬¡æ‰“å°

}

ç›´åˆ°ï¼š

![QQ_1727425627667](../assets/QQ_1727425627667.png)

ä¸‹ä¸€æ­¥æ˜¯è¿›å…¥æ— é™å¾ªç¯ã€‚

![QQ_1727425734530](../assets/QQ_1727425734530.png)

ç»“æŸã€‚é€šè¿‡ã€ Ctrl + Aï¼Œç„¶åæŒ‰ X ã€‘é€€å‡ºQEMUï¼Œé€šè¿‡`q`é€€å‡ºQEMUã€‚

> ç»ˆäºç®—æ˜¯æš‚æ—¶ç»“æŸäº† [/èººå¹³]
>
> ä¸‹ä¸€èŠ‚å¼€å§‹è½¬å‘ RUSTï¼

---

> ç­‰ç­‰ç­‰ç­‰ï¼Œå¥½åƒæŠŠ Makefile å¿˜äº†ï¼Ÿ
